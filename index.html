<!DOCTYPE html>
<html lang="en" data-custom-theme="default">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧮</text></svg>"
      type="image/svg+xml"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculator 1CP S1&S2 - Enhanced Mobile</title>
    <style>
      /* --- ENHANCEMENT: MODERNIZED LOOK & FEEL + DARK THEME - EVEN BETTERRRR --- */
      /* 1. CSS Variables for Theming (Light & Dark) */
      :root {
        /* Light Theme (Default) */
        --font-primary: "Inter", "Segoe UI", system-ui, sans-serif;

        --bg-primary: #f4f7f9;
        --bg-secondary: rgba(
          255,
          255,
          255,
          0.8
        ); /* Slightly less opaque for better blur */
        --bg-tertiary: #e9edf1;
        --bg-interactive: #e0e6eb;
        --bg-interactive-strong: #d1d8e0;

        --text-primary: #1a202c;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --text-on-accent: #ffffff;
        --text-accent: #2563eb; /* For highlighted text like results */

        --border-primary: #d1d8e0;
        --border-interactive: #a6b4c3;
        --border-focus: #2563eb;
        --border-danger: #ef4444;

        --accent-primary: #2563eb; /* Blue */
        --accent-secondary: #4f46e5; /* Indigo */
        --accent-success: #10b981; /* Green */
        --accent-warning: #f59e0b; /* Amber */
        --accent-danger: #ef4444; /* Red */
        --a: #9333ea; /* Purple - existing */

        --accent-primary-transparent-weak: rgba(37, 99, 235, 0.1);
        --accent-primary-transparent-medium: rgba(37, 99, 235, 0.2);
        --accent-primary-transparent-strong: rgba(37, 99, 235, 0.35);
        --accent-secondary-transparent-weak: rgba(79, 70, 229, 0.1);
        --accent-secondary-transparent-medium: rgba(79, 70, 229, 0.2);

        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.04),
          0 1px 2px -1px rgba(0, 0, 0, 0.02);
        --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.06),
          0 2px 4px -2px rgba(0, 0, 0, 0.03);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08),
          0 4px 6px -2px rgba(0, 0, 0, 0.04);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-inset: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);

        --blur-intensity: 10px; /* Increased blur for more pronounced glass effect */
        --border-radius-sm: 0.375rem; /* 6px */
        --border-radius-md: 0.5rem; /* 8px */
        --border-radius-lg: 0.75rem; /* 12px */
        --border-radius-xl: 1rem; /* 16px for larger cards */

        /* --- Enhanced Easing Functions & Durations --- */
        --ease-in-quad: cubic-bezier(0.55, 0.085, 0.68, 0.53);
        --ease-in-cubic: cubic-bezier(0.55, 0.055, 0.675, 0.19);
        --ease-in-quart: cubic-bezier(0.895, 0.03, 0.685, 0.22);
        --ease-in-quint: cubic-bezier(0.755, 0.05, 0.855, 0.06);
        --ease-in-expo: cubic-bezier(0.95, 0.05, 0.795, 0.035);
        --ease-in-circ: cubic-bezier(0.6, 0.04, 0.98, 0.335);

        --ease-out-quad: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        --ease-out-cubic: cubic-bezier(0.215, 0.61, 0.355, 1);
        --ease-out-quart: cubic-bezier(0.165, 0.84, 0.44, 1);
        --ease-out-quint: cubic-bezier(0.23, 1, 0.32, 1);
        --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1); /* Bouncy */
        --ease-out-circ: cubic-bezier(0.075, 0.82, 0.165, 1);
        --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1); /* Overshoot */

        --ease-in-out-quad: cubic-bezier(0.455, 0.03, 0.515, 0.955);
        --ease-in-out-cubic: cubic-bezier(0.645, 0.045, 0.355, 1);
        --ease-in-out-quart: cubic-bezier(0.77, 0, 0.175, 1);
        --ease-in-out-quint: cubic-bezier(0.86, 0, 0.07, 1);
        --ease-in-out-expo: cubic-bezier(1, 0, 0, 1);
        --ease-in-out-circ: cubic-bezier(0.785, 0.135, 0.15, 0.86);

        --md-standard: cubic-bezier(0.4, 0, 0.2, 1);
        --md-decelerate: cubic-bezier(0, 0, 0.2, 1);
        --md-accelerate: cubic-bezier(0.4, 0, 1, 1);

        --duration-fastest: 0.1s;
        --duration-fast: 0.15s;
        --duration-normal: 0.25s;
        --duration-medium: 0.35s;
        --duration-slow: 0.5s;
        --duration-slower: 0.7s; /* Extended for more graceful anims */
        --duration-slowest: 1s;

        --timing-interactive: var(--ease-out-cubic);
        --timing-enter: var(--ease-out-quart);
        --timing-exit: var(--ease-in-cubic);
        --timing-state-change: var(--ease-in-out-cubic);
        --timing-collapse: var(--ease-in-out-quart);
        --timing-reveal: var(--ease-out-quint);
        
        /* REFACTOR: Moved common variable aliases to :root */
        --p: var(--accent-primary);
        --s: var(--accent-secondary);
        --su: var(--accent-success);

        /* Colors for animated background spans */
        --anim-span-1-bg: rgba(37, 99, 235, 0.6);  /* Default Blue */
        --anim-span-2-bg: rgba(79, 70, 229, 0.7);  /* Default Indigo */
        --anim-span-3-bg: rgba(147, 51, 234, 0.5); /* Default Purple */
        --anim-span-4-bg: rgba(37, 99, 235, 0.55); /* Default Blue */
        --anim-span-5-bg: rgba(79, 70, 229, 0.65); /* Default Indigo */
        --anim-span-6-bg: rgba(147, 51, 234, 0.35); /* Default Purple */
        --anim-span-7-bg: rgba(37, 99, 235, 0.6);  /* Default Blue */
      }

      [data-theme="dark"] {
        --bg-primary: #101419; /* Darker base */
        --bg-secondary: rgba(
          22,
          27,
          34,
          0.8
        ); /* Darker with good blur contrast */
        --bg-tertiary: #1c2128;
        --bg-interactive: #282e36;
        --bg-interactive-strong: #3a404a;

        --text-primary: #e2e8f0;
        --text-secondary: #a0aec0;
        --text-muted: #718096;
        --text-accent: #60a5fa; /* Light blue for dark theme */

        --border-primary: #3b475c;
        --border-interactive: #5a677d;
        --border-focus: #60a5fa;
        --border-danger: #f87171; /* Lighter red for dark mode */

        --a: #a855f7; /* Lighter purple for dark mode */
        --accent-warning: #fcd34d; /* Lighter amber */

        --accent-primary-transparent-weak: rgba(96, 165, 250, 0.1);
        --accent-primary-transparent-medium: rgba(96, 165, 250, 0.2);
        --accent-primary-transparent-strong: rgba(96, 165, 250, 0.35);
        --accent-secondary-transparent-weak: rgba(129, 140, 248, 0.1);
        --accent-secondary-transparent-medium: rgba(129, 140, 248, 0.2);

        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
        --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.2),
          0 1px 2px -1px rgba(0, 0, 0, 0.15);
        --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.25),
          0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -2px rgba(0, 0, 0, 0.25);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3),
          0 10px 10px -5px rgba(0, 0, 0, 0.25);
        --shadow-inset: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);

        /* Dark mode animated background span colors */
        --anim-span-1-bg: rgba(79, 70, 229, 0.35);
        --anim-span-2-bg: rgba(37, 99, 235, 0.45);
        --anim-span-3-bg: rgba(168, 85, 247, 0.35);
        --anim-span-4-bg: rgba(79, 70, 229, 0.3);
        --anim-span-5-bg: rgba(37, 99, 235, 0.4);
        --anim-span-6-bg: rgba(168, 85, 247, 0.25);
        --anim-span-7-bg: rgba(79, 70, 229, 0.35);
      }
      /* --- OCEAN THEME --- */
      [data-custom-theme="ocean"]:not([data-theme="dark"]) {
          --bg-primary: #e0f7fa;
          --bg-secondary: rgba(179, 229, 252, 0.85);
          --bg-tertiary: #b3e5fc;
          --bg-interactive: #a7dde9;
          --bg-interactive-strong: #92cace;
          --text-primary: #004d40;
          --text-secondary: #006064;
          --text-muted: #007c83;
          --text-accent: #00796b;
          --border-primary: #7ac3d8;
          --border-interactive: #4db6ac;
          --border-focus: #00796b;
          --accent-primary: #00796b; /* Teal */
          --accent-secondary: #0288d1; /* Dodger Blue */
          --a: #00acc1; /* Cyan */
          --anim-span-1-bg: rgba(0, 121, 107, 0.65);
          --anim-span-2-bg: rgba(2, 136, 209, 0.75);
          --anim-span-3-bg: rgba(0, 172, 193, 0.55);
          --anim-span-4-bg: rgba(0, 121, 107, 0.60);
          --anim-span-5-bg: rgba(2, 136, 209, 0.70);
          --anim-span-6-bg: rgba(0, 172, 193, 0.40);
          --anim-span-7-bg: rgba(0, 121, 107, 0.65);
      }
      [data-custom-theme="ocean"][data-theme="dark"] {
          --bg-primary: #0a192f;
          --bg-secondary: rgba(13, 37, 63, 0.85);
          --bg-tertiary: #162f4b;
          --bg-interactive: #213f5f;
          --bg-interactive-strong: #2c4f73;
          --text-primary: #e0f7fa;
          --text-secondary: #b3e5fc;
          --text-muted: #88c8e8;
          --text-accent: #4dd0e1;
          --border-primary: #3c5f7c;
          --border-interactive: #609bb6;
          --border-focus: #4dd0e1;
          --accent-primary: #4dd0e1; /* Bright Cyan */
          --accent-secondary: #81d4fa; /* Bright Light Blue */
          --a: #26c6da; /* Brighter Cyan */
          --anim-span-1-bg: rgba(77, 208, 225, 0.40);
          --anim-span-2-bg: rgba(129, 212, 250, 0.50);
          --anim-span-3-bg: rgba(38, 198, 218, 0.40);
          --anim-span-4-bg: rgba(77, 208, 225, 0.35);
          --anim-span-5-bg: rgba(129, 212, 250, 0.45);
          --anim-span-6-bg: rgba(38, 198, 218, 0.30);
          --anim-span-7-bg: rgba(77, 208, 225, 0.40);
      }

      /* --- FOREST THEME --- */
      [data-custom-theme="forest"]:not([data-theme="dark"]) {
          --bg-primary: #f1f8e9;
          --bg-secondary: rgba(220, 237, 200, 0.85);
          --bg-tertiary: #dcedc8;
          --bg-interactive: #c5e1a5;
          --bg-interactive-strong: #b2d993;
          --text-primary: #2e7d32;
          --text-secondary: #388e3c;
          --text-muted: #558b2f;
          --text-accent: #4caf50;
          --border-primary: #a5d6a7;
          --border-interactive: #81c784;
          --border-focus: #4caf50;
          --accent-primary: #4caf50; /* Green */
          --accent-secondary: #689f38; /* Light Green */
          --a: #8bc34a; /* Lighter Green */
          --anim-span-1-bg: rgba(76, 175, 80, 0.65);
          --anim-span-2-bg: rgba(104, 159, 56, 0.75);
          --anim-span-3-bg: rgba(139, 195, 74, 0.55);
          --anim-span-4-bg: rgba(76, 175, 80, 0.60);
          --anim-span-5-bg: rgba(104, 159, 56, 0.70);
          --anim-span-6-bg: rgba(139, 195, 74, 0.40);
          --anim-span-7-bg: rgba(76, 175, 80, 0.65);
      }
      [data-custom-theme="forest"][data-theme="dark"] {
          --bg-primary: #1b261b;
          --bg-secondary: rgba(20, 38, 20, 0.85);
          --bg-tertiary: #273b27;
          --bg-interactive: #324e32;
          --bg-interactive-strong: #3e5f3e;
          --text-primary: #dcedc8;
          --text-secondary: #a5d6a7;
          --text-muted: #8dbd8e;
          --text-accent: #81c784;
          --border-primary: #4a784a;
          --border-interactive: #6a9a6a;
          --border-focus: #81c784;
          --accent-primary: #81c784; /* Light Green */
          --accent-secondary: #aed581; /* Lighter Lime */
          --a: #c5e1a5; /* Very Light Green */
          --anim-span-1-bg: rgba(129, 199, 132, 0.40);
          --anim-span-2-bg: rgba(174, 213, 129, 0.50);
          --anim-span-3-bg: rgba(197, 225, 165, 0.40);
          --anim-span-4-bg: rgba(129, 199, 132, 0.35);
          --anim-span-5-bg: rgba(174, 213, 129, 0.45);
          --anim-span-6-bg: rgba(197, 225, 165, 0.30);
          --anim-span-7-bg: rgba(129, 199, 132, 0.40);
      }

      /* --- SUNSET GLOW THEME --- */
      [data-custom-theme="sunset"]:not([data-theme="dark"]) {
          --bg-primary: #fff3e0; /* Pale Orange/Peach */
          --bg-secondary: rgba(255, 224, 178, 0.85); /* Light Orange, translucent */
          --bg-tertiary: #ffe0b2; /* Light Peach */
          --bg-interactive: #ffcc80;
          --bg-interactive-strong: #ffb74d;
          --text-primary: #c0392b; /* Dark Red */
          --text-secondary: #d35400; /* Pumpkin Orange */
          --text-muted: #e67e22; /* Carrot Orange */
          --text-accent: #e74c3c; /* Alizarin Crimson */
          --border-primary: #ffcc80;
          --border-interactive: #ffb74d;
          --border-focus: #e74c3c;
          --accent-primary: #e74c3c; /* Alizarin Crimson */
          --accent-secondary: #f39c12; /* Orange */
          --a: #d63031; /* Pomegranate */
          --anim-span-1-bg: rgba(231, 76, 60, 0.65); /* Crimson */
          --anim-span-2-bg: rgba(243, 156, 18, 0.75); /* Orange */
          --anim-span-3-bg: rgba(230, 126, 34, 0.55); /* Carrot */
          --anim-span-4-bg: rgba(231, 76, 60, 0.60);
          --anim-span-5-bg: rgba(243, 156, 18, 0.70);
          --anim-span-6-bg: rgba(230, 126, 34, 0.40);
          --anim-span-7-bg: rgba(231, 76, 60, 0.65);
      }
      [data-custom-theme="sunset"][data-theme="dark"] {
          --bg-primary: #2c1e2e; /* Dark Purple/Brown */
          --bg-secondary: rgba(60, 30, 50, 0.85); /* Dark Magenta/Brown, translucent */
          --bg-tertiary: #4a2e41; /* Darker Mauve */
          --bg-interactive: #6d4460;
          --bg-interactive-strong: #8b577a;
          --text-primary: #ffd1a4; /* Light Peach */
          --text-secondary: #ffb380; /* Lighter Orange */
          --text-muted: #ff9d63;
          --text-accent: #ff8a80; /* Light Coral */
          --border-primary: #86556c;
          --border-interactive: #a46787;
          --border-focus: #ff8a80;
          --accent-primary: #ff8a80; /* Light Coral */
          --accent-secondary: #ffab40; /* Bright Orange */
          --a: #e91e63; /* Pink for Dark Sunset */
          --anim-span-1-bg: rgba(255, 138, 128, 0.40); /* Light Coral */
          --anim-span-2-bg: rgba(255, 171, 64, 0.50); /* Bright Orange */
          --anim-span-3-bg: rgba(233, 30, 99, 0.40);   /* Pink */
          --anim-span-4-bg: rgba(255, 138, 128, 0.35);
          --anim-span-5-bg: rgba(255, 171, 64, 0.45);
          --anim-span-6-bg: rgba(233, 30, 99, 0.30);
          --anim-span-7-bg: rgba(255, 138, 128, 0.40);
      }

      /* --- MATRIX THEME --- */
      [data-custom-theme="matrix"]:not([data-theme="dark"]) { /* Matrix light is a bit of an oxymoron, so let's make it darkish */
          --bg-primary: #050505;
          --bg-secondary: rgba(5, 20, 5, 0.8);
          --bg-tertiary: #0a1a0a;
          --bg-interactive: #0f280f;
          --bg-interactive-strong: #143214;
          --text-primary: #00ff00; /* Bright Green */
          --text-secondary: #33ff33; /* Lighter Green */
          --text-muted: #66ff66;
          --text-accent: #00dd00;
          --border-primary: #005000;
          --border-interactive: #008000;
          --border-focus: #00ff00;
          --accent-primary: #00ff00;
          --accent-secondary: #33cc33;
          --a: #66ff66;
          --font-primary: "Consolas", "Menlo", "Monaco", monospace;
          --anim-span-1-bg: rgba(0, 255, 0, 0.5);
          --anim-span-2-bg: rgba(51, 255, 51, 0.6);
          --anim-span-3-bg: rgba(0, 204, 0, 0.4);
          --anim-span-4-bg: rgba(0, 255, 0, 0.45);
          --anim-span-5-bg: rgba(51, 255, 51, 0.55);
          --anim-span-6-bg: rgba(0, 204, 0, 0.3);
          --anim-span-7-bg: rgba(0, 255, 0, 0.5);
      }
      [data-custom-theme="matrix"][data-theme="dark"] { /* This will be very similar to matrix light by design */
          --bg-primary: #000000;
          --bg-secondary: rgba(0, 15, 0, 0.85);
          --bg-tertiary: #051005;
          --bg-interactive: #0a1f0a;
          --bg-interactive-strong: #0f280f;
          --text-primary: #00ff00;
          --text-secondary: #44ff44;
          --text-muted: #77ff77;
          --text-accent: #00ef00;
          --border-primary: #004000;
          --border-interactive: #006000;
          --border-focus: #00ff00;
          --accent-primary: #00ff00;
          --accent-secondary: #22ee22;
          --a: #55ff55;
          --font-primary: "Consolas", "Menlo", "Monaco", monospace;
          --anim-span-1-bg: rgba(0, 255, 0, 0.4);
          --anim-span-2-bg: rgba(51, 221, 51, 0.5);
          --anim-span-3-bg: rgba(0, 187, 0, 0.35);
          --anim-span-4-bg: rgba(0, 255, 0, 0.35);
          --anim-span-5-bg: rgba(51, 221, 51, 0.45);
          --anim-span-6-bg: rgba(0, 187, 0, 0.25);
          --anim-span-7-bg: rgba(0, 255, 0, 0.4);
      }
      /* Specific for matrix for titles and such */
      [data-custom-theme="matrix"] h2#main-title {
          font-family: "VT323", "Courier New", monospace; /* A more pixelated font */
          animation: titleGradient 6s linear infinite, subtleTextPulse 2s linear infinite alternate;
          background: linear-gradient(90deg, #00ff00, #33ff33, #00dd00, #00ff00);
          background-size: 400% 400%;
          text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 15px #008000;
      }
      [data-custom-theme="matrix"] .content-card,
      [data-custom-theme="matrix"] .app-header {
        border: 1px solid var(--accent-primary);
        box-shadow: 0 0 10px var(--accent-primary-transparent-medium), 0 0 20px var(--accent-primary-transparent-weak) inset;
      }


      *,
      *::before,
      *::after {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
      }

      html {
        scroll-behavior: smooth;
        font-size: 100%; /* Base for rem units */
      }

      body {
        font-family: var(--font-primary);
        background-color: var(--bg-primary);
        margin: 0;
        padding: 1.5rem;
        line-height: 1.6;
        color: var(--text-primary);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        transition: background-color var(--duration-normal)
            var(--timing-state-change),
          color var(--duration-normal) var(--timing-state-change),
          font-family var(--duration-normal) var(--timing-state-change); /* Added font-family transition */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      ::selection {
        background-color: var(--accent-primary);
        color: var(--text-on-accent);
        text-shadow: none;
      }

      /* Custom Scrollbar (Webkit) */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--accent-primary);
        border-radius: 10px;
        border: 2px solid var(--bg-tertiary);
        transition: background-color var(--duration-fast)
          var(--timing-interactive);
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-secondary);
      }

      .animated-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        pointer-events: none;
        background-image: linear-gradient(
          135deg,
          var(--bg-primary) 0%,
          var(--bg-interactive) 100%
        );
        transition: background-image var(--duration-slow)
          var(--timing-state-change);
      }

      .animated-bg span {
        position: absolute;
        display: block;
        list-style: none;
        border-radius: 50%;
        bottom: -200px; /* Start further down */
        animation-name: rise;
        animation-iteration-count: infinite;
        opacity: 0;
        will-change: transform, opacity;
        box-shadow: 0 0 10px 2px currentColor, 0 0 20px 5px currentColor inset; /* Inner and outer glow */
        filter: brightness(1.15); /* Pop more */
        transition: background-color var(--duration-normal) var(--timing-state-change); /* Smooth color transition */
      }

      @keyframes rise {
        0% {
          transform: translateY(0) translateX(0) rotate(0deg) scale(0.3);
          opacity: 0;
        }
        10% {
          opacity: 0.6; /* Increased for more visibility early */
        }
        90% {
          opacity: 0.1;
        }
        100% {
          transform: translateY(-140vh) translateX(var(--translateX-end, 50px))
            rotate(var(--rotate-end, 720deg)) scale(var(--scale-end, 1.4));
          opacity: 0;
        }
      }
      /* Varied shapes and glows, using themeable variables now */
      .animated-bg span:nth-child(1) {
        left: 20%; width: 80px; height: 80px; animation-duration: 28s; animation-delay: 0s;
        animation-timing-function: var(--ease-in-out-quint); --translateX-end: -30px; --rotate-end: 360deg; --scale-end: 1.4;
        background-color: var(--anim-span-1-bg);
      }
      .animated-bg span:nth-child(2) {
        left: 5%; width: 35px; height: 35px; animation-duration: 20s; animation-delay: 2s;
        animation-timing-function: var(--ease-out-back); --translateX-end: 20px; --rotate-end: -200deg; --scale-end: 1.2;
        background-color: var(--anim-span-2-bg);
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      }
      .animated-bg span:nth-child(3) {
        left: 75%; width: 30px; height: 30px; animation-duration: 25s; animation-delay: 4s;
        animation-timing-function: var(--ease-in-out-circ); --translateX-end: 60px; --rotate-end: 540deg; --scale-end: 1.1;
        background-color: var(--anim-span-3-bg);
        border-radius: 60% 40% 30% 70% / 50% 60% 40% 50%;
      }
      .animated-bg span:nth-child(4) {
        left: 35%; width: 65px; height: 65px; animation-duration: 22s; animation-delay: 0.5s;
        animation-timing-function: var(--ease-out-expo); --translateX-end: -50px; --rotate-end: 270deg; --scale-end: 1.3;
        background-color: var(--anim-span-4-bg);
      }
      .animated-bg span:nth-child(5) {
        left: 60%; width: 25px; height: 25px; animation-duration: 18s; animation-delay: 1.5s;
        animation-timing-function: var(--ease-in-out-expo); --translateX-end: 40px; --rotate-end: -360deg; --scale-end: 1.0;
        background-color: var(--anim-span-5-bg);
        border-radius: 20% 80% 50% 50% / 40% 30% 70% 60%;
      }
      .animated-bg span:nth-child(6) {
        left: 88%; width: 130px; height: 130px; animation-duration: 40s; animation-delay: 3s;
        animation-timing-function: var(--ease-in-out-quint); --translateX-end: -70px; --rotate-end: 180deg; --scale-end: 1.6;
        background-color: var(--anim-span-6-bg);
      }
      .animated-bg span:nth-child(7) {
        left: 48%; width: 45px; height: 45px; animation-duration: 21s; animation-delay: 5.5s;
        animation-timing-function: var(--ease-out-back); --translateX-end: 10px; --rotate-end: 600deg; --scale-end: 1.25;
        background-color: var(--anim-span-7-bg);
        border-radius: 70% 30% 80% 20% / 60% 70% 30% 40%;
      }
      /* Added more spans for engagement */
      .animated-bg span:nth-child(8) { /* Faster, smaller, sharp rise */
        left: 15%; width: 20px; height: 20px; animation-duration: 15s; animation-delay: 0.8s;
        animation-timing-function: var(--ease-in-quint); --translateX-end: 25px; --rotate-end: 300deg; --scale-end: 0.9;
        background-color: var(--anim-span-2-bg); /* Reusing a theme color */
      }
      .animated-bg span:nth-child(9) { /* Medium, distinct blob, slow drift */
        left: 80%; width: 55px; height: 55px; animation-duration: 35s; animation-delay: 6s;
        animation-timing-function: var(--ease-in-out-circ); --translateX-end: -40px; --rotate-end: -150deg; --scale-end: 1.35;
        background-color: var(--anim-span-4-bg);
        border-radius: 50% 50% 30% 70% / 60% 40% 70% 30%; /* Unique blob */
      }
      .animated-bg span:nth-child(10) { /* Large, very slow, gentle presence */
        left: 50%; transform: translateX(-50%); width: 110px; height: 110px; animation-duration: 55s; animation-delay: 8s;
        animation-timing-function: var(--ease-in-out-expo); --translateX-end: 10px; --rotate-end: 90deg; --scale-end: 1.7;
        background-color: var(--anim-span-6-bg);
      }


      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem; /* More space */
        padding: 0.75rem 1.25rem;
        background-color: var(--bg-secondary);
        border-radius: var(--border-radius-xl); /* Larger radius */
        box-shadow: var(--shadow-lg); /* More pronounced shadow */
        backdrop-filter: blur(var(--blur-intensity));
        position: sticky;
        top: 1rem;
        z-index: 100;
        border: 1px solid var(--border-primary);
        transition: box-shadow var(--duration-fast) var(--timing-interactive), background-color var(--duration-normal) var(--timing-state-change), border-color var(--duration-normal) var(--timing-state-change);
      }

      .app-controls {
        display: flex;
        gap: 1rem; /* Adjusted gap */
        align-items: center;
        flex-wrap: wrap;
      }
      .app-controls label:not(.sr-only) {
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        display: inline-flex;
        gap: 0.6rem;
        align-items: center;
        transition: color var(--duration-fast) var(--timing-interactive),
          transform var(--duration-fast) var(--ease-out-quad);
        padding: 0.25rem 0; /* Click area */
      }
      .app-controls label:not(.sr-only):hover {
        color: var(--text-primary);
        transform: scale(1.05);
      }
      .app-controls input[type="checkbox"] {
        width: 20px; /* Slightly larger */
        height: 20px;
        accent-color: var(--accent-primary);
        cursor: pointer;
        transform: scale(1.1); /* Match label hover better */
        transition: transform var(--duration-fast) var(--ease-out-quad);
      }
      .app-controls input[type="checkbox"]:hover {
        transform: scale(1.2);
      }
      .sr-only { /* For accessible labels that are not visible */
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      /* Styles for the new theme selector */
      .theme-select-container {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }
      .theme-select-container label { /* Visible label for the select dropdown */
          font-weight: 500;
          color: var(--text-secondary);
          font-size: 0.9em;
      }
      #theme-select-dropdown {
          padding: 0.5rem 0.8rem;
          border: 1px solid var(--border-primary);
          border-radius: var(--border-radius-md);
          background-color: var(--bg-tertiary);
          color: var(--text-primary);
          font-weight: 500;
          cursor: pointer;
          min-width: 130px;
          transition: border-color var(--duration-fast) var(--timing-interactive),
                      box-shadow var(--duration-fast) var(--timing-interactive),
                      background-color var(--duration-normal) var(--timing-state-change),
                      color var(--duration-normal) var(--timing-state-change);
        font-family: var(--font-primary); /* Ensure it picks up themed font */
      }
      #theme-select-dropdown:hover {
          border-color: var(--border-interactive);
          box-shadow: var(--shadow-sm);
      }
      #theme-select-dropdown:focus {
          border-color: var(--border-focus);
          box-shadow: 0 0 0 3.5px var(--accent-primary-transparent-strong);
          outline: none;
      }


      .theme-switcher-container {
        display: flex;
        align-items: center;
        gap: 1rem; /* Space between theme select and dark mode toggle */
      }
      .theme-switcher {
        position: relative;
        display: inline-block;
        width: 52px; /* Slightly wider */
        height: 30px;
      }
      .theme-switcher input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-interactive-strong);
        transition: background-color var(--duration-normal)
          var(--timing-state-change);
        border-radius: 30px;
      }
      .slider:before {
        /* The knob */
        position: absolute;
        content: "";
        height: 22px; /* Larger knob */
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: transform var(--duration-medium) var(--ease-out-expo),
          /* Bouncy */ background-color var(--duration-normal)
            var(--timing-state-change),
          box-shadow var(--duration-fast) var(--timing-interactive);
        border-radius: 50%;
        box-shadow: var(--shadow-sm);
      }
      [data-theme="dark"] .slider:before {
        background-color: var(--bg-tertiary);
        box-shadow: 0 0 8px 2px var(--accent-primary-transparent-medium); /* Subtle glow */
      }
      .theme-switcher input:checked + .slider {
        background-color: var(--accent-primary);
      }
      .theme-switcher input:focus-visible + .slider {
        /* Use focus-visible */
        box-shadow: 0 0 0 3px var(--accent-primary-transparent-strong);
      }
      .theme-switcher input:checked + .slider:before {
        transform: translateX(22px);
      }
      .slider::after {
        /* Sun/Moon icon */
        content: "☀️";
        font-size: 13px; /* Slightly larger */
        position: absolute;
        top: 50%;
        right: 7px; /* Adjusted for larger knob */
        transform: translateY(-50%) rotate(0deg);
        transition: opacity var(--duration-normal) var(--timing-state-change),
          transform var(--duration-normal) var(--ease-out-expo),
          left var(--duration-normal) var(--ease-out-expo),
          right var(--duration-normal) var(--ease-out-expo);
        opacity: 0.8;
      }
      .theme-switcher input:checked + .slider::after {
        content: "🌙";
        left: 7px;
        right: auto;
        transform: translateY(-50%) rotate(0deg); /* Smooth rotation if desired */
      }
      .theme-switcher input:not(:checked) + .slider::after {
        transform: translateY(-50%) rotate(0deg);
      }

      h2,
      h3 {
        margin: 0 0 1rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.01em;
        transition: color var(--duration-normal) var(--timing-state-change);
      }

      h2#main-title {
        font-size: 2.5rem; /* Larger */
        text-align: center;
        letter-spacing: -0.03em; /* Tighter */
        margin-bottom: 2rem;
        color: var(--text-primary);
        position: relative;
        z-index: 1;
        font-weight: 800; /* Bolder */

        background: linear-gradient(
          120deg,
          var(--p) 20%,
          var(--s) 50%,
          var(--a) 80%
        );
        -webkit-background-clip: text;
        -moz-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        -moz-text-fill-color: transparent;
        text-fill-color: transparent;
        background-size: 300% 300%; /* Larger size for smoother animation */
        animation: titleGradient 12s ease-in-out infinite,
          subtleTextPulse 4s ease-in-out infinite alternate;
         transition: background var(--duration-normal) var(--timing-state-change); /* Allow gradient colors to transition with theme */
      }

      @keyframes titleGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      @keyframes subtleTextPulse {
        from {
          text-shadow: 0 0 8px var(--accent-primary-transparent-weak);
        }
        to {
          text-shadow: 0 0 16px var(--accent-primary-transparent-medium);
        }
      }

      h3 {
        font-size: 1.6rem; /* Slightly larger */
        color: var(--text-secondary);
        font-weight: 600;
      }

      .content-card {
        background-color: var(--bg-secondary);
        backdrop-filter: blur(var(--blur-intensity));
        border-radius: var(--border-radius-xl); /* Larger radius */
        box-shadow: var(--shadow-lg);
        margin: 2rem auto; /* More spacing */
        padding: 2.5rem; /* More padding */
        transition: transform var(--duration-medium) var(--ease-out-back),
          /* Bouncy hover */ box-shadow var(--duration-medium)
            var(--ease-out-cubic),
          background-color var(--duration-normal) var(--timing-state-change),
          border-color var(--duration-normal) var(--timing-state-change); /* Use normal for color changes */
        border: 1px solid var(--border-primary);
        max-width: 900px;
        position: relative;
        z-index: 1;
      }

      /* Removed table specific styling */
      table {
        display: none;
      } /* Hide original tables */
      th,
      td,
      tr {
        display: block;
        border: none;
        padding: 0;
        margin: 0;
      } /* Remove default table display */

      input[type="number"],
      select {
        width: auto;
        min-width: 75px; /* Slightly wider */
        padding: 0.7rem 0.9rem; /* More padding */
        border: 1px solid var(--border-primary);
        border-radius: var(--border-radius-md);
        font-size: 0.95rem;
        transition: border-color var(--duration-fast) var(--timing-interactive),
          box-shadow var(--duration-fast) var(--timing-interactive),
          background-color var(--duration-normal) var(--timing-state-change), /* Changed to normal */
          color var(--duration-normal) var(--timing-state-change), /* Added color transition */
          transform var(--duration-fast) var(--ease-out-quad);
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 500;
        box-shadow: var(--shadow-inset); /* Default inset shadow */
        flex-grow: 1; /* Allow inputs to grow in flex containers */
        font-family: var(--font-primary); /* Ensure font consistency */
      }
      input[type="number"]:hover,
      select:hover {
        border-color: var(--border-interactive);
        box-shadow: var(--shadow-inset), var(--shadow-sm); /* Combine inset with outer sm */
        transform: scale(1.02);
      }
      input[type="number"]:focus,
      select:focus {
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3.5px var(--accent-primary-transparent-strong),
          var(--shadow-inset); /* Stronger focus ring */
        outline: none;
        background-color: var(--bg-secondary);
        transform: scale(1.05); /* Zoom more on focus */
      }
      input[type="number"]::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
      }

      span.g-l {
        font-size: 0.85rem; /* Clearer */
        color: var(--text-muted);
        display: inline-block;
        min-width: 60px;
        text-align: right;
        font-weight: 500;
      }

      .c-g,
      .m-g {
        display: flex; /* Use flex for input groups */
        flex-wrap: wrap; /* Wrap inputs/labels */
        align-items: center;
        gap: 0.75rem; /* More space */
        justify-content: flex-start; /* Align to start in the new layout */
        padding: 0.75rem 0; /* Padding within the group */
        border-top: 1px dashed var(--border-primary); /* Visual separation */
        margin-top: 0.75rem;
        transition: border-color var(--duration-normal) var(--timing-state-change);
      }
      .c-g:first-child,
      .m-g:first-child {
        border-top: none;
        margin-top: 0;
      } /* No top border for the first group */

      .c-g > div,
      .m-g > div {
        /* Individual input+label container */
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-grow: 1; /* Allow to grow in the flex wrap */
        min-width: 200px; /* Ensure they don't get too small before wrapping */
      }

      .c-g > div label,
      .m-g > div label {
        /* Specific label styling within groups */
        min-width: 80px; /* Give labels some consistent width */
        text-align: right;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.9rem;
        transition: color var(--duration-normal) var(--timing-state-change);
      }
      .c-g > div input,
      .m-g > div input {
        flex-grow: 1; /* Inputs take up remaining space */
      }

      .t-m {
        /* Manual toggle switch */
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem; /* Space below toggle */
        font-size: 0.95rem;
        color: var(--text-secondary);
        font-weight: 500;
        transition: color var(--duration-normal) var(--timing-state-change);
      }
      .t-m span {
        /* Text label for the toggle */
        flex-shrink: 0;
      }
      .t-m input[type="checkbox"] {
        appearance: none;
        width: 42px; /* Wider */
        height: 24px; /* Taller */
        background: var(--bg-interactive-strong);
        border-radius: var(--border-radius-xl); /* Fully rounded */
        position: relative;
        cursor: pointer;
        transition: background-color var(--duration-normal)
          var(--timing-state-change);
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
        flex-shrink: 0; /* Prevent it from shrinking */
        min-width: auto; /* Override input[type="number"] flex rule */
      }
      .t-m input[type="checkbox"]::before {
        /* The knob */
        content: "";
        position: absolute;
        width: 18px; /* Adjusted for new size */
        height: 18px;
        border-radius: 50%;
        background: white;
        top: 3px;
        left: 3px;
        transition: transform var(--duration-medium) var(--ease-out-expo); /* Bouncy */
        box-shadow: var(--shadow-sm);
      }
      .t-m input[type="checkbox"]:checked {
        background: var(--accent-success);
      }
      .t-m input[type="checkbox"]:checked::before {
        transform: translateX(18px); /* Adjusted */
      }
      .t-m label {
        /* Hide the default label text linked via 'for', keep only the span text */
        display: none;
      }

      button {
        padding: 0.9rem 1.85rem; /* More padding */
        background: linear-gradient(
          65deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        color: var(--text-on-accent);
        border: none;
        border-radius: var(--border-radius-md);
        font-weight: 700; /* Bolder */
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        box-shadow: var(--shadow-md),
          0 0 0 0 var(--accent-primary-transparent-medium); /* Initial state for pulse */
        font-size: 1rem; /* Larger base */
        text-transform: uppercase;
        letter-spacing: 0.05em; /* Wider spacing */
        position: relative;
        z-index: 1;
        overflow: hidden; /* For shimmer/effects */
        background-size: 200% auto; /* For gradient animation on hover */
        background-position: left center;
        transition: transform var(--duration-fast) var(--ease-out-back),
          /* Bouncy */ box-shadow var(--duration-fast) var(--ease-out-quad),
          opacity var(--duration-fast) var(--timing-interactive),
          background-position var(--duration-medium) var(--ease-in-out-cubic),
          background var(--duration-normal) var(--timing-state-change), /* For gradient colors */
          color var(--duration-normal) var(--timing-state-change);
        will-change: transform, box-shadow, background-position, background, color;
        font-family: var(--font-primary);
      }
      button:hover {
        transform: translateY(-4px) scale(1.05); /* More pop */
        box-shadow: var(--shadow-lg),
          0 0 20px 5px var(--accent-secondary-transparent-medium); /* Stronger glow */
        opacity: 1;
        background-position: right center; /* Animate gradient */
      }
      button:active {
        transform: translateY(-1px) scale(0.97); /* More noticeable press */
        box-shadow: var(--shadow-sm);
        opacity: 0.95;
      }
      /* Optional: Shimmer effect on primary buttons*/
      button.primary-action::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background-image: linear-gradient(
          to right,
          transparent 0%,
          transparent 40%,
          rgba(255, 255, 255, 0.25) 50%,
          transparent 60%,
          transparent 100%
        );
        transform: rotate(25deg) translateX(-120%);
        transition: transform 0s ease-in-out;
        pointer-events: none;
      }
      button.primary-action:hover::after {
        transform: rotate(25deg) translateX(120%);
        transition: transform var(--duration-slower) var(--ease-out-quint);
      }

      #a-b {
        /* Archi bonus button */
        background: linear-gradient(
          65deg,
          var(--s),
          var(--p)
        ); /* Different gradient */
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        text-transform: none;
        letter-spacing: 0.01em;
        flex-shrink: 0; /* Prevent button from shrinking in flex */
      }

      #t-s button,
      #missing-list button {
        background: linear-gradient(
          65deg,
          var(--p),
          var(--s)
        ); /* Standard gradient */
        font-size: 0.95rem;
      }
      #missing-list button.remove-missing-btn {
        /* Remove button, more specific selector */
        background: linear-gradient(65deg, var(--accent-danger), color-mix(in srgb, var(--accent-danger) 80%, black));
        padding: 0.6rem 1.1rem;
        flex-shrink: 0;
        margin-top: 0.75rem; /* Space above button */
        align-self: flex-end; /* Align to the right if flex container */
      }

      .r-b {
        /* Result block */
        background-color: var(--bg-tertiary);
        border-radius: var(--border-radius-xl); /* Match cards */
        padding: 2rem; /* More padding */
        margin-top: 2rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
        position: relative;
        z-index: 1;
        border: 1px solid var(--border-primary);
        transition: background-color var(--duration-normal) var(--timing-state-change),
                    border-color var(--duration-normal) var(--timing-state-change);
      }
      .r-b h3 {
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        font-size: 1.4rem;
      }
      #f-a,
      #t-f-a,
      #s2-f-a {
        /* Final average numbers */
        font-size: 2.5rem; /* Larger */
        font-weight: 800;
        color: var(--text-accent);
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: var(--border-radius-sm);
        background-color: var(
          --accent-primary-transparent-weak
        ); /* Subtle background */
        text-shadow: 0 0 12px var(--accent-primary-transparent-strong);
        transition: color var(--duration-fast) var(--timing-state-change),
          text-shadow var(--duration-fast) var(--timing-state-change),
          transform var(--duration-fast) var(--ease-out-quad),
          background-color var(--duration-normal) var(--timing-state-change);
      }
      /* JS can add .result-updated class to trigger animation on change */
      .result-updated {
        animation: resultValuePulse 0.6s var(--ease-out-back);
      }
      @keyframes resultValuePulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(
            1.2
          ); /* color: var(--accent-success); REMOVED: Color set by grade-color */
        }
        100% {
          transform: scale(1);
        }
      }

      .i-b {
        /* Info block */
        border-left: 6px solid var(--a); /* Thicker border */
        position: relative;
        z-index: 1;
        background: linear-gradient(
          to right,
          var(--bg-tertiary-alpha-info, color-mix(in srgb, var(--a) 5%, transparent)), /* Themed alpha background */
          transparent 70%
        );
        transition: border-left-color var(--duration-medium)
            var(--timing-interactive),
          background var(--duration-medium) var(--timing-interactive);
      }
      [data-theme="dark"] .i-b { /* Keep this structure but var(--a) will change by theme */
        --bg-tertiary-alpha-info: color-mix(in srgb, var(--a) 8%, transparent);
      }
      .i-b:hover {
        border-left-color: var(--s); /* Use secondary accent on hover */
        background: linear-gradient(
          to right,
          var(--bg-tertiary-alpha-info-hover, color-mix(in srgb, var(--s) 7%, transparent)),
          transparent 70%
        );
      }
      [data-theme="dark"] .i-b:hover { /* Theme changes var(--s) */
        --bg-tertiary-alpha-info-hover: color-mix(in srgb, var(--s) 10%, transparent);
      }

      .i-b p {
        margin: 0.85rem 0;
        padding: 0.85rem 1.25rem;
        background-color: transparent; /* Let parent .i-b handle bg */
        border-radius: var(--border-radius-md);
        font-weight: 500;
        color: var(--text-secondary);
        /* box-shadow: var(--shadow-xs); Removed, rely on parent card shadow */
        transition: color var(--duration-normal) var(--timing-state-change);
      }
      .i-b p strong {
        color: var(--text-primary);
        font-weight: 600;
         transition: color var(--duration-normal) var(--timing-state-change);
      }

      .f {
        /* Footer */
        text-align: center;
        margin: 2.5rem 0 1.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-primary);
        position: relative;
        z-index: 1;
        opacity: 0.8;
        transition: color var(--duration-normal) var(--timing-state-change), border-color var(--duration-normal) var(--timing-state-change);
      }

      @keyframes cardEnter {
        from {
          opacity: 0;
          transform: translateY(25px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .content-card {
        animation: cardEnter var(--duration-slower) var(--timing-reveal)
          backwards;
      }
      .content-card:nth-child(2) {
        animation-delay: 0.1s;
      }
      .content-card:nth-child(3) {
        animation-delay: 0.2s;
      }
      /* ...and so on if more cards, or use JS to stagger */

      .collapsible-section {
        transition-property: opacity, max-height, transform, margin, padding,
          border-width;
        transition-duration: var(--duration-medium);
        transition-timing-function: var(--timing-collapse); /* Updated easing */
        overflow: hidden;
        opacity: 1;
        max-height: 5000px; /* Ensure enough height for the new layout */
        transform: translateY(0);
      }
      .collapsible-section.collapsed {
        opacity: 0;
        max-height: 0 !important;
        transform: translateY(-15px); /* More pronounced movement */
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        border-width: 0 !important;
        overflow: hidden; /* Ensure content is clipped during collapse */
        /* Ensure the card shadow and border also collapse visually */
        box-shadow: none !important;
        border-color: transparent !important;
      }
      .collapsible-content-wrapper {
        min-height: 0; /* For flexbox/grid children */
      }

      /* --- New Module Card Styling --- */
      .module-item {
        background-color: var(--bg-tertiary);
        border-radius: var(--border-radius-lg);
        padding: 1.5rem; /* Padding inside module card */
        margin-bottom: 1.5rem; /* Space between module cards */
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-primary);
        transition: transform var(--duration-fast) var(--ease-out-quad),
          box-shadow var(--duration-fast) var(--ease-out-quad),
          background-color var(--duration-normal) var(--timing-state-change),
          border-color var(--duration-normal) var(--timing-state-change); /* Use normal */
        will-change: transform, box-shadow, background-color, border-color;
      }
      .module-item:last-child {
        margin-bottom: 0; /* No bottom margin on the last one */
      }
      .module-item:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-primary-transparent-medium);
      }

      .module-item h4 {
        margin: 0 0 0.5rem;
        font-size: 1.2rem; /* Module title size */
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Allow wrap on small screens */
        gap: 0.5rem;
        transition: color var(--duration-normal) var(--timing-state-change);
      }

      .module-item h4 > span {
        /* Coefficient styling */
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        flex-shrink: 0;
        transition: color var(--duration-normal) var(--timing-state-change);
      }

      .module-average {
        margin-top: 1.5rem; /* Space above average display */
        text-align: center;
        padding-top: 1rem;
        border-top: 1px dashed var(--border-primary); /* Visual separation */
        position: relative; /* For tooltip icon positioning */
        transition: border-color var(--duration-normal) var(--timing-state-change);
      }

      .module-average strong {
        font-size: 1.4rem; /* Larger average text */
        /* color: var(--text-accent); Color will be set by JS grade classes */
        transition: color var(--duration-fast) var(--timing-state-change); /* Smooth color change */
      }
      .module-average strong.grade-good {
        color: var(--accent-success);
      }
      .module-average strong.grade-average {
        color: var(--accent-warning);
      }
      .module-average strong.grade-poor {
        color: var(--accent-danger);
      }

      /* --- END New Module Card Styling --- */

      #missing-list {
        display: flex;
        flex-direction: column;
        gap: 1.25rem; /* More space */
      }
      .missing-module-item {
        background-color: var(--bg-tertiary);
        padding: 1.25rem; /* More padding */
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        opacity: 0;
        transform: translateX(-25px) scale(0.95); /* Start further out and smaller */
        max-height: 0;
        transition: opacity var(--duration-medium) var(--ease-out-cubic),
          transform var(--duration-medium) var(--ease-out-back),
          /* Bouncy entry */ max-height var(--duration-slow)
            var(--ease-in-out-quart),
          padding var(--duration-medium) var(--ease-out-cubic),
          margin var(--duration-medium) var(--ease-out-cubic),
          background-color var(--duration-normal) var(--timing-state-change),
          border-color var(--duration-normal) var(--timing-state-change); /* Added */
        overflow: hidden;
        border-left: 4px solid var(--accent-secondary); /* Indicator */
        margin-bottom: 0 !important; /* Initially no margin when collapsed */
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }
      .missing-module-item.is-visible {
        opacity: 1;
        transform: translateX(0) scale(1);
        max-height: 1000px; /* Increased max-height for weights panel */
        padding: 1.25rem !important;
        margin-bottom: 1.25rem !important; /* Restore margin */
      }
      .missing-module-item.is-visible:last-child {
        margin-bottom: 0 !important;
      }
      .missing-module-item h4 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--text-primary);
        font-size: 1.1rem;
         transition: color var(--duration-normal) var(--timing-state-change);
      }
      .missing-module-item > div.input-grade-group {
        /* Target only grade input groups for this styling */
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .missing-module-item > div.input-grade-group label {
        min-width: 85px; /* Wider */
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
        text-align: right; /* Align labels */
        transition: color var(--duration-normal) var(--timing-state-change);
      }
      .missing-module-item input[type="number"] {
        /* General selector for number inputs in missing item */
        /* width: 90px; No fixed width, let flex grow work */
        flex-grow: 1;
      }

      .reveal-on-scroll {
        opacity: 0;
        transform: translateY(40px) scale(0.95); /* More noticeable entry */
        transition: opacity var(--duration-slower) var(--timing-reveal),
          transform var(--duration-slower) var(--timing-reveal);
        transition-delay: 0.2s; /* Slightly longer delay */
      }
      .reveal-on-scroll.is-visible {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      /* --- STYLES FOR WEIGHT CUSTOMIZATION --- */
      .toggle-weights-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1em; /* Adjust size as needed */
        padding: 0.2rem 0.4rem;
        margin-left: 0.5rem;
        color: var(--text-secondary);
        transition: color var(--duration-fast) var(--timing-interactive),
          transform var(--duration-fast) var(--timing-interactive);
        vertical-align: middle; /* Align with text better */
      }
      .toggle-weights-btn:hover {
        color: var(--text-primary);
        transform: scale(1.1) rotate(15deg);
      }
      .weights-customization {
        border-top: 1px dashed var(--border-primary);
        margin-top: 1rem;
        padding-top: 1rem;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height var(--duration-medium) var(--timing-collapse),
          opacity var(--duration-medium) var(--timing-collapse),
          margin-top var(--duration-medium) var(--timing-collapse),
          padding-top var(--duration-medium) var(--timing-collapse),
          border-color var(--duration-normal) var(--timing-state-change);
      }
      .weights-customization.visible {
        max-height: 1000px; /* Adjust if more components */
        opacity: 1;
      }
      .weights-customization h5 {
        /* Smaller heading for this section */
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        font-weight: 600;
         transition: color var(--duration-normal) var(--timing-state-change);
      }
      .weight-input-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .weight-input-group label {
        min-width: 120px; /* Adjust for longer labels like "CF Weight (%):" */
        text-align: right;
        font-size: 0.85rem;
        color: var(--text-secondary);
         transition: color var(--duration-normal) var(--timing-state-change);
      }
      .weight-input-group input[type="number"].component-weight-input {
        /* More specific selector */
        width: 80px; /* Fixed width for percentage inputs */
        flex-grow: 0; /* Don't allow to grow */
        border-width: 1px; /* For invalid border */
        transition: border-color 0.2s ease-in-out,
                    background-color var(--duration-normal) var(--timing-state-change), /* For theme */
                    color var(--duration-normal) var(--timing-state-change); /* For theme */
      }
      .weight-input-group
        input[type="number"].component-weight-input.invalid-weight-sum {
        border-color: var(--border-danger);
        box-shadow: 0 0 0 2px
          color-mix(in srgb, var(--border-danger) 30%, transparent);
      }
      .weights-sum-warning {
        color: var(--accent-danger);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        font-weight: 500;
         transition: color var(--duration-normal) var(--timing-state-change);
      }
      .weights-sum-warning strong {
        font-weight: 700;
      }
      .weights-customization button {
        /* Reset weights button */
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        margin-top: 0.5rem;
        background: linear-gradient(
          65deg,
          var(--bg-interactive-strong),
          var(--bg-interactive)
        );
        color: var(--text-secondary);
        text-transform: none;
        letter-spacing: normal;
      }
      .weights-customization button:hover {
        color: var(--text-primary);
        background: linear-gradient(
          65deg,
          var(--bg-interactive),
          var(--bg-interactive-strong)
        );
      }
      /* --- END STYLES FOR WEIGHT CUSTOMIZATION --- */

      /* --- Module Calc Tooltip --- */
      .calc-tooltip-icon {
        font-size: 0.8em;
        margin-left: 8px;
        cursor: help;
        color: var(--text-muted);
        position: relative; /* For tooltip child */
        display: inline-block; /* To make it behave well with the strong tag */
        vertical-align: middle;
         transition: color var(--duration-normal) var(--timing-state-change);
      }
      .calc-tooltip-icon:hover {
        color: var(--text-accent);
      }
      .calc-tooltiptext {
        visibility: hidden;
        width: auto; /* auto width based on content */
        min-width: 250px; /* minimum width */
        max-width: 400px;
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        text-align: left;
        font-size: 0.8rem;
        font-weight: normal; /* override strong */
        border-radius: var(--border-radius-md);
        padding: 0.75rem;
        position: absolute;
        z-index: 10;
        bottom: 125%; /* Position above the icon */
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity var(--duration-fast) ease-in-out,
          visibility var(--duration-fast) ease-in-out,
          background-color var(--duration-normal) var(--timing-state-change), /* Theme */
          color var(--duration-normal) var(--timing-state-change), /* Theme */
          border-color var(--duration-normal) var(--timing-state-change); /* Theme */
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-primary);
        pointer-events: none; /* Allow clicks to pass through if not directly on it */
      }
      .calc-tooltip-icon:hover .calc-tooltiptext,
      .calc-tooltip-icon:focus .calc-tooltiptext {
        /* Added focus for accessibility */
        visibility: visible;
        opacity: 1;
        pointer-events: auto; /* Make it interactive when visible */
      }
      .calc-tooltiptext::after {
        /* Arrow for tooltip */
        content: "";
        position: absolute;
        top: 100%; /* At the bottom of the tooltip */
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: var(--bg-tertiary) transparent transparent transparent;
        transition: border-color var(--duration-normal) var(--timing-state-change); /* Theme */
      }
      [data-theme="dark"] .calc-tooltiptext::after {
        border-color: var(--bg-tertiary) transparent transparent transparent;
      }

      /* --- PARTY MODE ENHANCEMENTS --- */
      @keyframes partyBackground {
        0% { background-color: #ff0000; } 7% { background-color: #ff7f00; } 14% { background-color: #ffff00; }
        21% { background-color: #00ff00; } 28% { background-color: #00ffff; } 35% { background-color: #0000ff; }
        42% { background-color: #8b00ff; } 49% { background-color: #ff00ff; } 56% { background-color: #ff1493; }
        63% { background-color: #32cd32; } 70% { background-color: #ffa500; } 77% { background-color: #adff2f; }
        84% { background-color: #ff69b4; } 91% { background-color: #00fa9a; } 100% { background-color: #ff0000; }
      }
      @keyframes partyDance {
        0%, 100% { transform: rotate(0deg) translateX(0px) translateY(0px) scale(1); }
        25% { transform: rotate(-2deg) translateX(-3px) translateY(-2px) scale(1.01); }
        50% { transform: rotate(0deg) translateX(0px) translateY(0px) scale(0.99); }
        75% { transform: rotate(2deg) translateX(3px) translateY(2px) scale(1.01); }
      }
      @keyframes partyHueRotate {
        0% { filter: hue-rotate(0deg) saturate(1.5); } 100% { filter: hue-rotate(360deg) saturate(1.5); }
      }
      @keyframes partyTextColor {
        0% { color: #ff0000; } 10% { color: #ff7f00; } 20% { color: #ffff00; } 30% { color: #00ff00; }
        40% { color: #00ffff; } 50% { color: #0000ff; } 60% { color: #8b00ff; } 70% { color: #ff00ff; }
        80% { color: #ff1493; } 90% { color: #32cd32; } 100% { color: #ff0000; }
      }

      html.party-mode .animated-bg {
        animation: partyBackground 0.5s linear infinite; /* Faster cycle */
        background-image: none !important;
      }
      html.party-mode .animated-bg span {
        opacity: 1 !important;
        animation-duration: var(--duration-fastest) !important;
        animation-timing-function: steps(2, jump-none) !important; /* Strobe-like */
        box-shadow: 0 0 25px 12px currentColor, 0 0 40px 20px currentColor inset !important; /* Intense glow */
        filter: brightness(1.5) saturate(2);
      }
      html.party-mode .content-card,
      html.party-mode .app-header,
      html.party-mode button,
      html.party-mode .module-item, /* Add module item */
      html.party-mode .missing-module-item /* Add missing item */ {
        animation: partyDance 0.2s linear infinite alternate, partyHueRotate 1s linear infinite;
      }
      html.party-mode h2#main-title {
        animation: partyDance 0.15s linear infinite alternate, titleGradient 1.5s ease-in-out infinite, partyTextColor 0.4s linear infinite;
        -webkit-text-fill-color: unset !important; /* Allow color animation */
        -moz-text-fill-color: unset !important; text-fill-color: unset !important;
        background: none !important; /* Disable gradient background for text color cycle */
        font-family: "Comic Sans MS", "Chalkduster", fantasy !important; /* Party font! */
      }
      html.party-mode input, html.party-mode select, html.party-mode .r-b {
        animation: partyDance 0.3s ease-in-out infinite alternate;
      }

      /* --- Confetti Canvas --- */
      #confetti-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 9999;
      }
      
      /* --- WELCOME MODAL STYLES --- */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 2000; /* Above everything else */
          opacity: 0;
          visibility: hidden;
          transition: opacity var(--duration-normal) var(--timing-enter), visibility 0s var(--duration-normal) linear;
          padding: 1rem; /* Ensure padding for small screens */
      }
      .modal-overlay.visible {
          opacity: 1;
          visibility: visible;
          transition: opacity var(--duration-normal) var(--timing-enter), visibility 0s linear;
      }

      .modal-content {
          background-color: var(--bg-primary);
          color: var(--text-primary);
          padding: 2rem 2.5rem;
          border-radius: var(--border-radius-xl);
          box-shadow: var(--shadow-xl);
          max-width: 600px;
          width: 100%; /* Full width up to max-width */
          position: relative;
          transform: translateY(-30px) scale(0.9); /* More pronounced entry animation */
          transition: transform var(--duration-medium) var(--timing-reveal),
                      opacity var(--duration-medium) var(--timing-reveal), /* Animate opacity too */
                      background-color var(--duration-normal) var(--timing-state-change),
                      color var(--duration-normal) var(--timing-state-change);
          max-height: 90vh;
          overflow-y: auto;
          opacity: 0;
      }
      .modal-overlay.visible .modal-content {
          transform: translateY(0) scale(1);
          opacity: 1;
      }

      .modal-content h2 {
          color: var(--accent-primary);
          text-align: center;
          margin-top: 0;
          margin-bottom: 0.75rem;
          font-size: 1.8rem;
          transition: color var(--duration-normal) var(--timing-state-change);
      }
      .modal-content p {
          margin-bottom: 1.5rem;
          text-align: center;
          font-size: 1.05rem;
          color: var(--text-secondary);
          transition: color var(--duration-normal) var(--timing-state-change);
      }
      .modal-content p strong {
          color: var(--text-primary);
          font-weight: 700;
          transition: color var(--duration-normal) var(--timing-state-change);
      }

      .modal-close-btn {
          position: absolute;
          top: 0.75rem;
          right: 0.75rem;
          background: transparent;
          border: none;
          font-size: 2.2rem; /* Larger */
          color: var(--text-muted);
          cursor: pointer;
          padding: 0.2rem 0.5rem;
          line-height: 1;
          transition: color var(--duration-fast) var(--timing-interactive), transform var(--duration-fast) var(--timing-interactive);
          z-index: 10; /* Ensure above other modal content if overlapping */
      }
      .modal-close-btn:hover {
          color: var(--text-primary);
          transform: scale(1.15) rotate(90deg); /* More interaction */
      }

      .modal-actions {
          display: flex;
          justify-content: center;
          gap: 1rem;
          margin-bottom: 1.5rem;
          flex-wrap: wrap; /* Allow buttons to wrap on small screens */
      }
      .modal-actions button { 
          font-size: 0.9rem;
          padding: 0.7rem 1.3rem;
      }
      .modal-actions button#show-guide-btn {
          background: linear-gradient(65deg, var(--accent-success), color-mix(in srgb, var(--accent-success) 85%, black));
      }
      .modal-actions button#dismiss-welcome-btn {
          background: linear-gradient(65deg, var(--bg-interactive-strong), var(--bg-interactive));
          color: var(--text-secondary);
      }
      .modal-actions button#dismiss-welcome-btn:hover {
           color: var(--text-primary);
      }


      .guide-section {
          border-top: 1px solid var(--border-primary);
          padding-top: 1.5rem;
          margin-top: 1.5rem;
          text-align: left;
          transition: border-color var(--duration-normal) var(--timing-state-change);
          animation: fadeInGuide 0.5s var(--ease-out-cubic);
      }
      @keyframes fadeInGuide {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }
      .guide-section h3 {
          text-align: center;
          color: var(--text-accent);
          margin-bottom: 1rem;
          font-size: 1.5rem;
          transition: color var(--duration-normal) var(--timing-state-change);
      }
      .guide-section ul {
          list-style: none; /* Changed from 'disc' to none for cleaner look with emoji */
          padding-left: 0; /* Removed default padding */
      }
      .guide-section ul li {
          margin-bottom: 0.8rem;
          font-size: 0.95rem;
          line-height: 1.6; /* Slightly more line height for readability */
          color: var(--text-secondary);
          transition: color var(--duration-normal) var(--timing-state-change);
          padding-left: 1.8em; /* Space for emoji bullet */
          position: relative;
      }
      .guide-section ul li::before { /* Emoji bullets */
        content: '🔹'; /* Default bullet */
        position: absolute;
        left: 0;
        top: 0.05em; /* Adjust vertical alignment */
        color: var(--accent-primary);
        font-size: 0.9em;
         transition: color var(--duration-normal) var(--timing-state-change);
      }
      .guide-section ul li:nth-child(1)::before { content: '🕹️';} /* Modes */
      .guide-section ul li:nth-child(2)::before { content: '✍️';} /* Grades */
      .guide-section ul li:nth-child(3)::before { content: '⚖️';} /* Custom Weights */
      .guide-section ul li:nth-child(4)::before { content: '🎨';} /* Themes */
      .guide-section ul li:nth-child(5)::before { content: '🎉';} /* Party Time */
      .guide-section ul li:nth-child(6)::before { content: '🔄';} /* Reset */

      .guide-section ul li strong {
          color: var(--text-primary);
          font-weight: 600;
          margin-right: 0.3em;
          transition: color var(--duration-normal) var(--timing-state-change);
      }
      .guide-section ul li em {
          color: var(--p); /* Use primary accent color */
          font-style: normal;
          font-weight: 500; /* Slightly bolder for emphasis */
          transition: color var(--duration-normal) var(--timing-state-change);
      }
      /* End Welcome Modal Styles */

      @media (max-width: 768px) {
        body { padding: 1rem 0.75rem; }
        .app-header { flex-direction: column; gap: 1rem; padding: 1rem; top: 0.75rem; }
        .app-controls { flex-direction: column; justify-content: center; gap: 0.75rem; width:100%;} /* Stack controls */
        .theme-select-container { width: auto; max-width:250px; justify-content: center;} /* Center theme select */
        #theme-select-dropdown { width: 100%; }
        .theme-switcher-container { justify-content: center; margin-top: 0.5rem; }


        h2#main-title { font-size: 2rem; }
        h3 { font-size: 1.35rem; }
        .content-card, .collapsible-section { margin: 1.25rem auto; padding: 1.5rem; border-radius: var(--border-radius-lg); }
        .module-item { padding: 1rem; margin-bottom: 1rem; }
        .module-item h4 { font-size: 1.1rem; flex-direction: column; align-items: flex-start; }
        .module-item h4 > span { font-size: 0.85rem; margin-top: 0.2rem; }
        .module-item h4 .toggle-weights-btn { margin-left: 0; margin-top: 0.3rem; }
        .c-g > div, .m-g > div { flex-direction: column; align-items: flex-start; gap: 0.25rem; min-width: 100%; }
        .c-g > div label, .m-g > div label { text-align: left; min-width: auto; }
        .c-g, .m-g { flex-direction: column; gap: 0.5rem; padding: 0.5rem 0; }
        button { padding: 0.8rem 1.5rem; font-size: 0.9rem; letter-spacing: 0.03em; }
        #f-a, #t-f-a, #s2-f-a { font-size: 2rem; }
        .animated-bg span:nth-child(n + 8) { display: none; } /* Show fewer, now up to 7 shown */
        .missing-module-item { padding: 1rem !important; margin-bottom: 1rem !important; }
        .missing-module-item > div.input-grade-group { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
        .missing-module-item > div.input-grade-group label { text-align: left; min-width: auto; }
        .missing-module-item button.remove-missing-btn { align-self: stretch; margin-top: 0.5rem; }
        .weight-input-group { flex-direction: column; align-items: flex-start; }
        .weight-input-group label { text-align: left; min-width: auto; margin-bottom: 0.2rem; }
        .weight-input-group input[type="number"].component-weight-input { width: 100%; }
        .calc-tooltiptext { left: 5%; transform: translateX(0); width: 90%; }
        .calc-tooltiptext::after { left: 10%; }
        .modal-content { padding: 1.5rem; } /* Adjust modal padding */
        .modal-content h2 { font-size: 1.6rem; }
        .guide-section ul li { font-size: 0.9rem; padding-left: 1.6em; }
      }
      @media (max-width: 480px) {
        body { padding: 0.5rem; }
        .app-header { padding: 0.75rem; top: 0.5rem; }
        .app-controls label:not(.sr-only) { font-size: 0.9rem; gap: 0.5rem; }
        .app-controls input[type="checkbox"] { width: 18px; height: 18px; }
        .theme-select-container label { font-size: 0.85rem; }
        #theme-select-dropdown { padding: 0.4rem 0.7rem; font-size:0.9rem;}

        .theme-switcher { width: 48px; height: 26px; }
        .theme-switcher .slider:before { width: 20px; height: 20px; left: 3px; bottom: 3px; }
        .theme-switcher input:checked + .slider:before { transform: translateX(22px); }
        .slider::after { font-size: 11px; right: 6px; }
        .theme-switcher input:checked + .slider::after { left: 6px; }
        h2#main-title { font-size: 1.7rem; }
        h3 { font-size: 1.2rem; }
        .content-card, .collapsible-section { padding: 1rem; margin: 1rem auto; }
        .module-item { padding: 0.75rem; margin-bottom: 0.75rem; }
        .module-item h4 { font-size: 1rem; }
        .c-g > div, .m-g > div { min-width: 100%; }
        button { padding: 0.7rem 1.2rem; font-size: 0.85rem; }
        #f-a, #t-f-a, #s2-f-a { font-size: 1.75rem; }
        .animated-bg span:nth-child(n + 6) { display: none; } /* Even fewer, now up to 5 shown */
        .missing-module-item { padding: 0.75rem !important; margin-bottom: 0.75rem !important; }
        .modal-content { padding: 1rem; } /* Adjust modal padding */
        .modal-content h2 { font-size: 1.4rem; }
        .modal-content p { font-size: 0.95rem; margin-bottom: 1rem;}
        .modal-actions button { font-size: 0.8rem; padding: 0.6rem 1rem; }
        .guide-section h3 { font-size: 1.3rem; }
        .guide-section ul li { font-size: 0.85rem; }
      }
    </style>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet"> <!-- For Matrix theme title -->
  </head>

  <body>
    <div class="animated-bg"></div>
    <canvas id="confetti-canvas"></canvas>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close welcome message">&times;</button>
            <h2>🎉 Welcome! 🎉</h2>
            <p>This calculator is made by <strong>Walid</strong>, enhanced with AI.</p>
            <div class="modal-actions">
                <button id="show-guide-btn">Show Quick Guide</button>
                <button id="dismiss-welcome-btn">Get Started</button>
            </div>
            <div id="guide-content" class="guide-section" style="display: none;">
                <h3>🚀 Quick Guide</h3>
                <ul>
                    <li><strong>Modes:</strong> There is a <em>Talents Mode</em> where you can enter only missing subjects and <em>S2 Mode is always avaible too </em>. Choose between the two.</li>
                    <li><strong>Grades:</strong> Input grades. Hover 'ⓘ' by module average for formula details.</li>
                    <li><strong>Custom Weights:</strong> Click '⚙️' by module name to customize component weights. Saved locally!</li>
                    <li><strong>Themes:</strong> Pick a 'Theme' and use ☀️/🌙 for Light/Dark mode.</li>
                    <li><strong>Party Time:</strong> Try Konami Code (↑ ↑ ↓ ↓ ← → ← → B A) for 10 seconds of fun!</li>
                    <li><strong>Reset:</strong> 'Reset All' button at bottom clears inputs & weights.</li>
                </ul>
                <p style="text-align: center; margin-top:1rem; font-size:0.9em; color:var(--text-muted);">Happy Calculating!</p>
            </div>
        </div>
    </div>


    <header class="app-header">
      <div class="app-controls">
        <label><input type="checkbox" id="t-m-global" onchange="tTM()" /> Talents Mode</label>
        <label><input type="checkbox" id="s2-m-global" onchange="toggleS2()" /> S2 Mode</label>
      </div>
      <div class="theme-switcher-container">
        <div class="theme-select-container">
            <label for="theme-select-dropdown" class="sr-only">Select Theme</label> <!-- Added sr-only for screen readers if no visible label -->
            <select id="theme-select-dropdown">
                <option value="default">Default</option>
                <option value="ocean">Ocean Blue</option>
                <option value="forest">Forest Green</option>
                <option value="sunset">Sunset Glow</option>
                <option value="matrix">Matrix Code</option>
            </select>
        </div>
        <label class="theme-switcher" for="theme-toggle" title="Toggle Dark Mode">
          <input type="checkbox" id="theme-toggle" aria-label="Toggle dark mode" />
          <span class="slider"></span>
        </label>
      </div>
    </header>

    <h2 id="main-title">1CP S1 Avg Calc</h2>

    <!-- Talents Mode Section (Already card-like) -->
    <div
      id="t-s"
      class="content-card collapsible-section collapsed"
      style="display: block"
    >
      <div class="collapsible-content-wrapper">
        <h3>Recover Missing Module from Talents Avg</h3>
        <div style="margin-bottom: 1rem">
          <label
            for="t-a"
            style="display: block; margin-bottom: 0.5rem; font-weight: 600"
            >Enter Talents Avg:</label
          ><input
            type="number"
            id="t-a"
            min="0"
            max="20"
            step="0.5"
            style="width: 100%; max-width: 200px"
            oninput="cM()"
          />
        </div>
        <div
          style="
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
          "
        >
          <div>
            <label
              for="m-m"
              style="display: block; margin-bottom: 0.5rem; font-weight: 600"
              >Select Module:</label
            ><select id="m-m" style="width: 100%; max-width: 200px">
              <option value="">-- Choose Module --</option>
            </select>
          </div>
          <button onclick="addMissing()">Add Module</button>
        </div>
        <div id="missing-list" style="margin-bottom: 1rem"></div>
        <button onclick="cM()">Calc Semester Avg</button>
        <div class="r-b">
          <h3>The Semester Avg: <span id="t-f-a">0.00</span></h3>
        </div>
      </div>
    </div>

    <!-- S1 Modules List (Replaces S1 table) -->
    <div
      id="s1-modules"
      class="content-card collapsible-section"
      style="display: block"
    >
      <div class="collapsible-content-wrapper">
        <!-- Modules will be injected here by JS -->
      </div>
    </div>

    <!-- S1 Calculation Button and Result -->
    <div style="text-align: center; margin: 1.5rem 0">
      <button id="s1-calc" class="primary-action" onclick="cA()">Calc S1 Avg</button>
    </div>
    <div class="r-b" id="s1-result" style="text-align: center">
      <h3>S1 Avg: <span id="f-a">0.00</span></h3>
    </div>

    <!-- S2 Modules List (Replaces S2 table) -->
    <div
      id="s2-modules"
      class="content-card collapsible-section collapsed"
      style="display: block"
    >
      <div class="collapsible-content-wrapper">
        <!-- Modules will be injected here by JS -->
      </div>
    </div>

    <!-- S2 Calculation Button and Result -->
    <div style="text-align: center; margin: 1.5rem 0">
      <button id="s2-calc" class="primary-action" onclick="cA_S2()" style="display: none">
        Calc S2 Avg
      </button>
    </div>
    <div class="r-b" id="s2-result" style="text-align: center; display: none">
      <h3>S2 Avg: <span id="s2-f-a">0.00</span></h3>
    </div>

    <!-- Formula Display (Already card-like) -->
    <div class="i-b content-card reveal-on-scroll" id="formula-display">
      <!-- Content will be set by JS based on S1/S2 mode -->
    </div>

    <div class="f">
      Made by Walid - Enhanced UI by Expert AI       try this ↑ ↑ ↓ ↓ ← → ← → B A
    </div>

    <script>
      // --- MODULE DEFINITIONS (NEW STRUCTURE) ---
      const mC = [
        {
          code: "SYS1",
          coef: 3,
          fields: ["TD", "IN (/8)", "CI", "CF"],
          components: [
            { id: "td", label: "TD", defaultWeight: 0.1, inputMax: 20, preWeightScale: 1, },
            { id: "in", label: "IN (/8)", defaultWeight: 0.1, inputMax: 8, preWeightScale: 2.5, },
            { id: "ci", label: "CI", defaultWeight: 0.3, inputMax: 20, preWeightScale: 1, },
            { id: "cf", label: "CF", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ARCHI", coef: 4, fields: ["CF", "CI"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
          ], hasBonus: true, bonusValue: 1,
        }, {
          code: "ALG1", coef: 3, fields: ["CF", "CI"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.67, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.33, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ANA1", coef: 5, fields: ["CF", "CI"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.67, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.33, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "TEE", coef: 2, fields: ["CF", "CC (/20)"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 2 / 3, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC (/20)", defaultWeight: 1 / 3, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ALSDS", coef: 5, fields: ["CF", "CI", "TP1", "TP2", "TR (/20)"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.3, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.2, inputMax: 20, preWeightScale: 1, },
            { id: "tp1", label: "TP1", defaultWeight: 0.2, inputMax: 20, preWeightScale: 1, },
            { id: "tp2", label: "TP2", defaultWeight: 0.2, inputMax: 20, preWeightScale: 1, },
            { id: "tr", label: "TR (/20)", defaultWeight: 0.1, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "BWEB", coef: 1, fields: ["CF", "CI", "CC"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.4, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.4, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC", defaultWeight: 0.2, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ELECT", coef: 3, fields: ["CF", "CI", "CC=INT1+INT2"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.25, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC=INT1+INT2", defaultWeight: 0.25, inputMax: 20, preWeightScale: 1, },
          ],
        },
      ];
      const mC2 = [
        {
          code: "SYS2", coef: 3, fields: ["FE", "ME", "CC"],
          components: [
            { id: "fe", label: "FE", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
            { id: "me", label: "ME", defaultWeight: 0.3, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC", defaultWeight: 0.2, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "MECA", coef: 3, fields: ["CF", "CI", "CC"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.25, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC", defaultWeight: 0.25, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ALG2", coef: 3, fields: ["CF", "CI"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.67, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.33, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ANA2", coef: 5, fields: ["CF", "CI"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.67, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.33, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "TEO", coef: 2, fields: ["CF", "CC"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 1 / 3, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC", defaultWeight: 2 / 3, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          // MODIFICATION: Updated ALSDD structure and weights as per new requirements.
          code: "ALSDD", coef: 5, fields: ["TPc", "CC", "Interos (INT1+INT2)", "TP", "CF"],
          components: [
            { id: "tpc", label: "TPc", defaultWeight: 0.25 * 0.5, inputMax: 20, preWeightScale: 1, },      // 50% of 25% Note TD
            { id: "cc", label: "CC", defaultWeight: 0.25 * 0.25, inputMax: 20, preWeightScale: 1, },       // 25% of 25% Note TD
            { id: "interos", label: "Interos (INT1+INT2)", defaultWeight: 0.25 * 0.25, inputMax: 20, preWeightScale: 1, }, // 25% of 25% Note TD
            { id: "tp", label: "TP", defaultWeight: 0.20, inputMax: 20, preWeightScale: 1, },
            { id: "cf", label: "CF", defaultWeight: 0.55, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ANG", coef: 2, fields: ["CI", "CC", "CF"],
          components: [
            { id: "ci", label: "CI", defaultWeight: 0.33, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC", defaultWeight: 0.33, inputMax: 20, preWeightScale: 1, },
            { id: "cf", label: "CF", defaultWeight: 0.34, inputMax: 20, preWeightScale: 1, },
          ],
        }, {
          code: "ELECTF", coef: 4, fields: ["CF", "CI", "CC"],
          components: [
            { id: "cf", label: "CF", defaultWeight: 0.5, inputMax: 20, preWeightScale: 1, },
            { id: "ci", label: "CI", defaultWeight: 0.25, inputMax: 20, preWeightScale: 1, },
            { id: "cc", label: "CC", defaultWeight: 0.25, inputMax: 20, preWeightScale: 1, },
          ],
        },
      ];

      let aB = false; // Archi Bonus flag
      let isS2 = false; // S2 Mode flag
      const tCoef = mC.reduce((sum, mod) => sum + mod.coef, 0);
      const tCoefS2 = mC2.reduce((sum, mod) => sum + mod.coef, 0);
      let customWeights = {};
      let calculationDetailsCache = {}; // To store tooltip content

      // --- HELPER FUNCTIONS ---
      function gIV(containerSelector) {
        const container =
          typeof containerSelector === "string"
            ? document.querySelector(containerSelector)
            : containerSelector;
        if (!container) return [];
        return Array.from(
          container.querySelectorAll('input[type="number"].grade-input')
        ).map((input) => {
          const val = parseFloat(input.value);
          const max = parseFloat(input.max);
          if (isNaN(val)) return 0;
          return Math.min(Math.max(val, 0), max); // Clamp grades
        });
      }

      function getGradeColorClass(grade) {
        if (grade >= 10) return "grade-good";
        if (grade >= 8) return "grade-average";
        return "grade-poor";
      }

      // --- CORE CALCULATION LOGIC ---
      function cMA(moduleCode, gradesArray, isManualMode, semester = "S1") {
        if (isManualMode) {
          const manualAvg = gradesArray[0] || 0;
          calculationDetailsCache[
            moduleCode
          ] = `Manual Entry: ${manualAvg.toFixed(2)}`;
          return manualAvg;
        }

        const moduleList = semester === "S1" ? mC : mC2;
        const moduleDef = moduleList.find((m) => m.code === moduleCode);
        if (!moduleDef) return 0;

        let weightedSum = 0;
        let calculationString = `${moduleCode}: `;
        let terms = [];

        moduleDef.components.forEach((component, index) => {
          const grade = gradesArray[index] || 0;
          const scaledGrade = grade * (component.preWeightScale || 1);

          let weight = component.defaultWeight;
          if (
            customWeights[moduleCode] &&
            typeof customWeights[moduleCode][component.id] === "number"
          ) {
            weight = customWeights[moduleCode][component.id];
          }
          weightedSum += scaledGrade * weight;
          let termString = `(${grade.toFixed(2)}`;
          if (component.preWeightScale && component.preWeightScale !== 1)
            termString += ` × ${component.preWeightScale}`;
          termString += `) × ${(weight * 100).toFixed(0)}%`;
          terms.push(termString);
        });
        calculationString += terms.join(" + ");

        if (
          moduleDef.hasBonus &&
          moduleCode === "ARCHI" &&
          semester === "S1" &&
          aB
        ) {
          weightedSum += moduleDef.bonusValue || 1;
          calculationString += ` + Bonus(${moduleDef.bonusValue || 1})`;
        }
        calculationString += ` = ${weightedSum.toFixed(2)}`;
        calculationDetailsCache[moduleCode] = calculationString;
        return weightedSum;
      }

      function calculateAndUpdateSemesterAvg(
        semesterModules,
        totalSemesterCoef,
        finalAvgElementId,
        avgSpanPrefix = "a-",
        isS2Semester = false
      ) {
        let totalWeightedAvg = 0;
        let allModuleAvgs = []; // For confetti check

        semesterModules.forEach((module) => {
          const moduleCodeLower = module.code.toLowerCase();
          const manualToggle = document.getElementById(
            `${isS2Semester ? "s2-" : ""}t-m-${moduleCodeLower}`
          );
          const isManual = manualToggle ? manualToggle.checked : false;

          const moduleItem = document.querySelector(
            `.module-item[data-code="${module.code}"]`
          );
          if (!moduleItem) return;

          const gradesContainer = moduleItem.querySelector(
            isManual ? ".m-g" : ".c-g"
          );
          const grades = gIV(gradesContainer);

          const moduleAvg = cMA(
            module.code,
            grades,
            isManual,
            isS2Semester ? "S2" : "S1"
          );
          allModuleAvgs.push(moduleAvg);

          const avgSpan = document.getElementById(
            `${avgSpanPrefix}${moduleCodeLower}`
          );
          if (avgSpan) {
            avgSpan.textContent = moduleAvg.toFixed(2);
            avgSpan.className = getGradeColorClass(moduleAvg); // Apply color class
            avgSpan.classList.remove("result-updated");
            void avgSpan.offsetWidth;
            avgSpan.classList.add("result-updated");

            const tooltipSpan = avgSpan.nextElementSibling; // Assuming icon is next sibling
            if (
              tooltipSpan &&
              tooltipSpan.classList.contains("calc-tooltip-icon")
            ) {
              const tooltipText =
                tooltipSpan.querySelector(".calc-tooltiptext");
              if (tooltipText)
                tooltipText.textContent =
                  calculationDetailsCache[module.code] ||
                  "Details not available.";
            }
          }
          totalWeightedAvg += moduleAvg * module.coef;
        });

        const finalAvgValue = totalSemesterCoef > 0 ? totalWeightedAvg / totalSemesterCoef : 0;
        const finalAvgDisplay = finalAvgValue.toFixed(2);

        const finalAvgSpan = document.getElementById(finalAvgElementId);
        finalAvgSpan.textContent = finalAvgDisplay;
        finalAvgSpan.className = getGradeColorClass(finalAvgValue); // Apply color to final avg too
        finalAvgSpan.classList.remove("result-updated");
        void finalAvgSpan.offsetWidth;
        finalAvgSpan.classList.add("result-updated");

        if (
          finalAvgValue >= 10 &&
          !document.documentElement.classList.contains("party-mode")
        ) {
          // High average check
          triggerConfetti();
        }
      }

      function cA() {
        calculateAndUpdateSemesterAvg(mC, tCoef, "f-a", "a-", false);
      }
      function cA_S2() {
        calculateAndUpdateSemesterAvg(mC2, tCoefS2, "s2-f-a", "a-s2-", true);
      }

      const missing = [];

      function addMissing() {
        const moduleSelect = document.getElementById("m-m");
        const selectedCode = moduleSelect.value;
        if (!selectedCode || missing.find((m) => m.code === selectedCode))
          return;

        const currentModuleSet = isS2 ? mC2 : mC;
        const moduleData = currentModuleSet.find(
          (m) => m.code === selectedCode
        );
        if (!moduleData) return;

        missing.push({
          code: selectedCode,
          coef: moduleData.coef,
          fields: moduleData.fields,
          components: moduleData.components,
          hasBonus: moduleData.hasBonus,
          bonusValue: moduleData.bonusValue,
        });

        const missingListDiv = document.getElementById("missing-list");
        const moduleItemDiv = document.createElement("div");
        moduleItemDiv.id = `miss-${selectedCode}`;
        moduleItemDiv.className = "missing-module-item";
        moduleItemDiv.dataset.code = selectedCode;

        let gradeInputsHTML = moduleData.fields
          .map((fieldLabel, idx) => {
            const component = moduleData.components[idx];
            return `
                <div class="input-grade-group">
                    <label for="miss-${selectedCode}-${component.id}-grade">${fieldLabel}</label>
                    <input type="number" id="miss-${selectedCode}-${component.id}-grade" class="grade-input" 
                           min="0" max="${component.inputMax}" step="0.5" oninput="cM()">
                </div>
            `;
          })
          .join("");

        moduleItemDiv.innerHTML = `
            <h4>${selectedCode} <span>(coef ${moduleData.coef})</span>
                <button class="toggle-weights-btn" title="Customize Weights" aria-label="Customize weights for ${selectedCode}" data-module="${selectedCode}" data-type="missing">⚙️</button>
            </h4>
            ${gradeInputsHTML}
            ${generateWeightsPanelHTML(moduleData, true)}
            <button class="remove-missing-btn" data-code="${selectedCode}">Remove</button>
        `;

        missingListDiv.appendChild(moduleItemDiv);
        requestAnimationFrame(() => {
          void moduleItemDiv.offsetWidth;
          moduleItemDiv.classList.add("is-visible");
        });

        addWeightsEventListeners(moduleItemDiv, selectedCode, true);
        moduleSelect.value = "";
        cM();
      }

      document
        .getElementById("missing-list")
        .addEventListener("click", function (event) {
          if (event.target.classList.contains("remove-missing-btn")) {
            const moduleCodeToRemove = event.target.dataset.code;
            const moduleItemDiv = document.getElementById(
              `miss-${moduleCodeToRemove}`
            );
            if (moduleItemDiv) {
              moduleItemDiv.classList.remove("is-visible");
              moduleItemDiv.addEventListener(
                "transitionend",
                () => {
                  if (moduleItemDiv.parentNode === this)
                    this.removeChild(moduleItemDiv);
                },
                { once: true }
              );
            }
            const index = missing.findIndex(
              (m) => m.code === moduleCodeToRemove
            );
            if (index > -1) missing.splice(index, 1);
            cM();
          }
        });

      function cM() {
        const talentsAvgInput =
          parseFloat(document.getElementById("t-a").value) || 0;
        const totalCoefCurrent = isS2 ? tCoefS2 : tCoef;
        let n = talentsAvgInput * totalCoefCurrent;

        missing.forEach((module) => {
          const moduleItemDiv = document.getElementById(`miss-${module.code}`);
          if (!moduleItemDiv) return;
          const grades = Array.from(
            moduleItemDiv.querySelectorAll('input[type="number"].grade-input')
          ).map((input) => parseFloat(input.value) || 0);
          const moduleAvg = cMA(module.code, grades, false, isS2 ? "S2" : "S1");
          n += moduleAvg * module.coef;
        });

        const finalAvgValue = totalCoefCurrent > 0 ? n / totalCoefCurrent : 0;
        const finalAvgDisplay = finalAvgValue.toFixed(2);

        const finalAvgSpan = document.getElementById("t-f-a");
        finalAvgSpan.textContent = finalAvgDisplay;
        finalAvgSpan.className = getGradeColorClass(finalAvgValue);
        finalAvgSpan.classList.remove("result-updated");
        void finalAvgSpan.offsetWidth;
        finalAvgSpan.classList.add("result-updated");
        if (
          finalAvgValue >= 10 &&
          !document.documentElement.classList.contains("party-mode")
        )
          triggerConfetti();
      }

      function tAB() {
        aB = !aB;
        const archiButton = document.getElementById("a-b");
        if (archiButton)
          archiButton.textContent = aB ? "Remove 1pt Bonus" : "Add 1pt Bonus";
        (isS2 ? cA_S2 : cA)();
      }

      function toggleManualAvgUI(moduleItem, moduleCode, isS2Module, isManual) {
        const gradesContainer = moduleItem.querySelector(".c-g");
        const manualContainer = moduleItem.querySelector(".m-g");
        const weightsCustomizationPanel = moduleItem.querySelector(
          ".weights-customization"
        );
        const toggleWeightsBtn = moduleItem.querySelector(
          ".toggle-weights-btn"
        ); // Hide weights button too

        if (gradesContainer)
          gradesContainer.style.display = isManual ? "none" : "flex";
        if (manualContainer)
          manualContainer.style.display = isManual ? "block" : "none";
        if (weightsCustomizationPanel) {
          weightsCustomizationPanel.style.display = isManual
            ? "none"
            : weightsCustomizationPanel.classList.contains("visible")
            ? "block"
            : "none";
        }
        if (toggleWeightsBtn)
          toggleWeightsBtn.style.display = isManual ? "none" : "inline-block";
        
        (isS2Module ? cA_S2 : cA)();
      }

      function toggleModuleManualMode(moduleCodeLower, isS2Module) {
        const sPrefix = isS2Module ? "s2-" : "";
        const moduleListSelector = isS2Module ? "#s2-modules" : "#s1-modules";

        const moduleItem = document.querySelector(
          `${moduleListSelector} .module-item[data-code="${moduleCodeLower.toUpperCase()}"]`
        );
        if (!moduleItem) return;
        
        const manualCheckbox = document.getElementById(`${sPrefix}t-m-${moduleCodeLower}`);
        toggleManualAvgUI(
          moduleItem,
          moduleCodeLower.toUpperCase(),
          isS2Module,
          manualCheckbox.checked
        );
      }
      
      const talentModeToggle = document.getElementById("t-m-global");
      const s2ModeToggle = document.getElementById("s2-m-global");
      const talentSection = document.getElementById("t-s");
      const s1ModulesSection = document.getElementById("s1-modules");
      const s2ModulesSection = document.getElementById("s2-modules");
      const s1CalcButton = document.getElementById("s1-calc");
      const s2CalcButton = document.getElementById("s2-calc");
      const s1ResultBlock = document.getElementById("s1-result");
      const s2ResultBlock = document.getElementById("s2-result");
      const formulaDisplay = document.getElementById("formula-display");
      const mainTitle = document.getElementById("main-title");
      const missingModuleSelect = document.getElementById("m-m");

      function tTM() {
        const isTalentsMode = talentModeToggle.checked;
        s2ModeToggle.disabled = isTalentsMode;
        talentSection.classList.toggle("collapsed", !isTalentsMode);
        if (isTalentsMode) {
          s1ModulesSection.classList.add("collapsed");
          s2ModulesSection.classList.add("collapsed");
          s1CalcButton.style.display = "none";
          s2CalcButton.style.display = "none";
          s1ResultBlock.style.display = "none";
          s2ResultBlock.style.display = "none";
          mainTitle.textContent = `1CP Talents Avg Calc (${
            isS2 ? "S2" : "S1"
          })`;
          updateMissingModuleSelectOptions(isS2 ? mC2 : mC);
        } else {
          toggleS2();
        }
        if (!isTalentsMode) {
          document.getElementById("missing-list").innerHTML = "";
          missing.length = 0;
        }
      }

      function toggleS2() {
        if (talentModeToggle.checked) {
          isS2 = s2ModeToggle.checked;
          mainTitle.textContent = `1CP Talents Avg Calc (${
            isS2 ? "S2" : "S1"
          })`;
          updateMissingModuleSelectOptions(isS2 ? mC2 : mC);
          document.getElementById("missing-list").innerHTML = "";
          missing.length = 0;
          cM();
          return;
        }
        isS2 = s2ModeToggle.checked;
        updateFormulaDisplay();
        mainTitle.textContent = `1CP ${isS2 ? "S2" : "S1"} Avg Calc`;
        s1ModulesSection.classList.toggle("collapsed", isS2);
        s2ModulesSection.classList.toggle("collapsed", !isS2);
        s1CalcButton.style.display = isS2 ? "none" : "inline-block";
        s2CalcButton.style.display = isS2 ? "inline-block" : "none";
        s1ResultBlock.style.display = isS2 ? "none" : "block";
        s2ResultBlock.style.display = isS2 ? "block" : "none";
        document.getElementById("f-a").textContent = "0.00";
        document.getElementById("s2-f-a").textContent = "0.00";
        document.getElementById("f-a").className = "";
        document.getElementById("s2-f-a").className = ""; // Clear color class
        isS2 ? cA_S2() : cA();
      }

      function updateFormulaDisplay() {
        const currentModules = isS2 ? mC2 : mC;
        let formulaHTML = `<h3>Calc Formulas (${
          isS2 ? "S2" : "S1"
        }) Default Weights</h3>`;
        currentModules.forEach((mod) => {
          // MODIFICATION: Changed the map function to create minimized formula text
          let formulaStr = mod.components.map((comp) => {
              const compName = comp.label.split(" ")[0];
              let gradePart = compName;
              if (comp.preWeightScale && comp.preWeightScale !== 1) {
                  gradePart = `(${compName} × ${comp.preWeightScale})`;
              }
              // Format to (Weight% Component) or (Weight% (Component x Scale))
              return `(${(comp.defaultWeight * 100).toFixed(0)}% ${gradePart})`;
          }).join(" + ");

          if (mod.hasBonus && mod.code === "ARCHI" && !isS2)
            formulaStr += " + <i>opt. 1pt bonus</i>";
          formulaHTML += `<p><strong>${mod.code}:</strong> ${formulaStr}</p>`;
        });
        formulaDisplay.innerHTML = formulaHTML;
      }

      function updateMissingModuleSelectOptions(modules) {
        missingModuleSelect.innerHTML =
          '<option value="">-- Choose Module --</option>';
        modules.forEach((module) => {
          const option = document.createElement("option");
          option.value = module.code;
          option.textContent = module.code;
          missingModuleSelect.appendChild(option);
        });
      }

      function generateWeightsPanelHTML(moduleData, isMissing = false) {
        const prefix = isMissing
          ? `miss-${moduleData.code}-`
          : `${moduleData.code.toLowerCase()}-`;
        let weightsHTML = moduleData.components
          .map((comp) => {
            const currentWeightVal =
              customWeights[moduleData.code] &&
              typeof customWeights[moduleData.code][comp.id] === "number"
                ? customWeights[moduleData.code][comp.id] * 100
                : comp.defaultWeight * 100;
            return `
                <div class="weight-input-group">
                    <label for="${prefix}${comp.id}-weight">${
              comp.label.split(" ")[0]
            } Weight (%):</label>
                    <input type="number" id="${prefix}${
              comp.id
            }-weight" class="component-weight-input"
                           data-module="${
                             moduleData.code
                           }" data-component-id="${comp.id}"
                           min="0" max="100" step="0.1" value="${currentWeightVal.toFixed(
                             1
                           )}">
                </div>`;
          })
          .join("");
        return `<div class="weights-customization"><h5 tabindex="-1">Customize Component Weights</h5>${weightsHTML}<p class="weights-sum-warning" style="display: none;">Total weights for <strong>${
          moduleData.code
        }</strong> not 100%.</p><button class="reset-weights-btn" data-module="${
          moduleData.code
        }" data-type="${
          isMissing ? "missing" : "regular"
        }">Reset to Default Weights</button></div>`;
      }

      function addWeightsEventListeners(
        moduleItemElement,
        moduleCode,
        isMissing = false
      ) {
        const toggleBtn = moduleItemElement.querySelector(
          `.toggle-weights-btn[data-module="${moduleCode}"]`
        );
        const weightsPanel = moduleItemElement.querySelector(
          ".weights-customization"
        );
        const resetBtn = moduleItemElement.querySelector(
          `.reset-weights-btn[data-module="${moduleCode}"]`
        );
        const weightInputs = moduleItemElement.querySelectorAll(
          `.component-weight-input[data-module="${moduleCode}"]`
        );
        const warningP = moduleItemElement.querySelector(
          ".weights-sum-warning"
        );
        const moduleDef =
          (isS2 && !isMissing && mC2.find((m) => m.code === moduleCode)) ||
          (!isS2 && !isMissing && mC.find((m) => m.code === moduleCode)) ||
          (isS2 && isMissing && mC2.find((m) => m.code === moduleCode)) ||
          (!isS2 && isMissing && mC.find((m) => m.code === moduleCode));

        if (toggleBtn) {
          toggleBtn.addEventListener("click", () => {
            const isVisible = weightsPanel.classList.toggle("visible");
            weightsPanel.style.display = isVisible ? "block" : "none";
            if (isVisible) weightsPanel.querySelector("h5").focus(); // Focus into panel for a11y
          });
        }
        weightInputs.forEach((input) => {
          input.addEventListener("input", () => {
            const componentId = input.dataset.componentId;
            const value = parseFloat(input.value);
            if (!customWeights[moduleCode]) customWeights[moduleCode] = {};
            customWeights[moduleCode][componentId] = isNaN(value)
              ? undefined
              : value / 100;
            saveCustomWeights();
            checkWeightsSum(moduleCode, warningP, weightInputs, moduleDef);
            if (isMissing) cM();
            else if (isS2) cA_S2();
            else cA();
          });
        });
        if (resetBtn) {
          resetBtn.addEventListener("click", () => {
            delete customWeights[moduleCode];
            saveCustomWeights();
            if (moduleDef) {
              moduleDef.components.forEach((comp) => {
                const inputField = moduleItemElement.querySelector(
                  `.component-weight-input[data-component-id="${comp.id}"]`
                );
                if (inputField)
                  inputField.value = (comp.defaultWeight * 100).toFixed(1);
              });
            }
            if (warningP) warningP.style.display = "none";
            weightInputs.forEach((inp) =>
              inp.classList.remove("invalid-weight-sum")
            );
            if (isMissing) cM();
            else if (isS2) cA_S2();
            else cA();
          });
        }
        // Initial check on load if weights are present
        checkWeightsSum(moduleCode, warningP, weightInputs, moduleDef);
      }

      function checkWeightsSum(
        moduleCode,
        warningP,
        weightInputsNodeList,
        moduleDef
      ) {
        if (!warningP || !moduleDef) return;
        let sum = 0;
        moduleDef.components.forEach((comp) => {
          let weight = comp.defaultWeight;
          if (
            customWeights[moduleCode] &&
            typeof customWeights[moduleCode][comp.id] === "number"
          ) {
            weight = customWeights[moduleCode][comp.id];
          }
          sum += weight;
        });
        const sumIsNot100 = Math.abs(sum - 1.0) > 0.001;
        warningP.style.display = sumIsNot100 ? "block" : "none";
        warningP.querySelector("strong").textContent = moduleCode;
        weightInputsNodeList.forEach((inp) =>
          inp.classList.toggle("invalid-weight-sum", sumIsNot100)
        );
      }

      function saveCustomWeights() {
        localStorage.setItem("customWeights", JSON.stringify(customWeights));
      }
      function loadCustomWeights() {
        const saved = localStorage.getItem("customWeights");
        if (saved) customWeights = JSON.parse(saved);
      }

      function generateModuleHTML(moduleData, isS2Module = false) {
        const moduleCode = moduleData.code;
        const moduleCodeLower = moduleCode.toLowerCase();
        const avgId = isS2Module
          ? `a-s2-${moduleCodeLower}`
          : `a-${moduleCodeLower}`;
        const toggleId = isS2Module
          ? `s2-t-m-${moduleCodeLower}`
          : `t-m-${moduleCodeLower}`;
        const toggleFunction = `toggleModuleManualMode('${moduleCodeLower}', ${isS2Module})`;

        let gradesInputsHTML = moduleData.fields
          .map((fieldLabel, idx) => {
            const component = moduleData.components[idx];
            const inputId = `${isS2Module ? "s2-" : ""}${moduleCodeLower}-${
              component.id
            }-grade`;
            return `<div><label for="${inputId}">${fieldLabel}</label><input type="number" id="${inputId}" class="grade-input" min="0" max="${
              component.inputMax
            }" step="0.5" oninput="${isS2Module ? "cA_S2()" : "cA()"}"></div>`;
          })
          .join("");
        if (!isS2Module && moduleCode === "ARCHI" && moduleData.hasBonus)
          gradesInputsHTML += `<button id="a-b" onclick="tAB()">Add 1pt Bonus</button>`;

        const moduleItem = document.createElement("div");
        moduleItem.className = `module-item`;
        moduleItem.dataset.code = moduleCode;
        moduleItem.innerHTML = `
            <h4>${moduleCode} <span>(coef ${moduleData.coef})</span>
                <button class="toggle-weights-btn" title="Customize Weights" aria-label="Customize weights for ${moduleCode}" data-module="${moduleCode}" data-type="regular">⚙️</button>
            </h4>
            <div class="t-m"> <input type="checkbox" id="${toggleId}" onchange="${toggleFunction}" /><span id="${toggleId}-label">Manual Avg Entry</span> </div>
            <div class="c-g">${gradesInputsHTML}</div>
            <div class="m-g" style="display:none;"><div><label>Module Avg:</label><input type="number" class="grade-input" min="0" max="20" step="0.5" placeholder="Enter avg" oninput="${
              isS2Module ? "cA_S2()" : "cA()"
            }"></div></div>
            ${generateWeightsPanelHTML(moduleData)}
            <div class="module-average"> Average: <strong id="${avgId}">0.00</strong><span class="calc-tooltip-icon" tabindex="0" aria-label="Show calculation details for ${moduleCode}">ⓘ<span class="calc-tooltiptext">Details here.</span></span></div>`;
        addWeightsEventListeners(moduleItem, moduleCode, false);
        return moduleItem;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const animatedBg = document.querySelector('.animated-bg');
        if (animatedBg) {
            for (let i = 0; i < 10; i++) {
                animatedBg.appendChild(document.createElement('span'));
            }
        }

        // --- WELCOME MODAL LOGIC ---
        const welcomeModal = document.getElementById('welcome-modal');
        const showGuideBtn = document.getElementById('show-guide-btn');
        const guideContent = document.getElementById('guide-content');
        const dismissWelcomeBtn = document.getElementById('dismiss-welcome-btn');
        const modalCloseBtn = welcomeModal.querySelector('.modal-close-btn');

        function showWelcomeModal() {
            if (welcomeModal) {
                welcomeModal.style.display = 'flex';
                setTimeout(() => { // Allow display to apply before transition
                    welcomeModal.classList.add('visible');
                }, 10);
            }
        }

        function hideWelcomeModal() {
            if (welcomeModal) {
                welcomeModal.classList.remove('visible');
                const handleTransitionEnd = () => {
                    if (!welcomeModal.classList.contains('visible')) {
                        welcomeModal.style.display = 'none';
                        if(guideContent) guideContent.style.display = 'none'; // Reset guide content visibility
                        if(showGuideBtn) showGuideBtn.textContent = 'Show Quick Guide'; // Reset button text
                    }
                    welcomeModal.removeEventListener('transitionend', handleTransitionEnd);
                };
                welcomeModal.addEventListener('transitionend', handleTransitionEnd);
            }
        }

        if (showGuideBtn) {
            showGuideBtn.addEventListener('click', () => {
                if (guideContent) {
                    const isHidden = guideContent.style.display === 'none';
                    guideContent.style.display = isHidden ? 'block' : 'none';
                    showGuideBtn.textContent = isHidden ? 'Hide Guide' : 'Show Quick Guide';
                }
            });
        }
        if (dismissWelcomeBtn) dismissWelcomeBtn.addEventListener('click', hideWelcomeModal);
        if (modalCloseBtn) modalCloseBtn.addEventListener('click', hideWelcomeModal);
        
        showWelcomeModal(); // Show modal on page load
        // --- END WELCOME MODAL LOGIC ---


        loadCustomWeights();
        const s1ModulesContainer = document.querySelector(
          "#s1-modules .collapsible-content-wrapper"
        );
        mC.forEach((module) =>
          s1ModulesContainer.appendChild(generateModuleHTML(module, false))
        );
        const s2ModulesContainer = document.querySelector(
          "#s2-modules .collapsible-content-wrapper"
        );
        mC2.forEach((module) =>
          s2ModulesContainer.appendChild(generateModuleHTML(module, true))
        );

        talentSection.classList.add("collapsed");
        s2ModulesSection.classList.add("collapsed");
        s1ModulesSection.classList.remove("collapsed");
        updateFormulaDisplay();
        updateMissingModuleSelectOptions(mC);
        cA();

        // --- New Theme Management ---
        const appThemeToggle = document.getElementById('theme-toggle'); // HTML id is 'theme-toggle'
        const appThemeSelect = document.getElementById('theme-select-dropdown');

        function setAppTheme(customTheme, isDarkMode) {
            document.documentElement.setAttribute('data-custom-theme', customTheme);
            localStorage.setItem('selectedCustomTheme', customTheme);
            if (appThemeSelect) appThemeSelect.value = customTheme;

            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem('darkModePreference', isDarkMode ? 'dark' : 'light');
            if (appThemeToggle) appThemeToggle.checked = isDarkMode;
        }

        const initialCustomTheme = localStorage.getItem('selectedCustomTheme') || 'default';
        let initialIsDarkMode;
        const savedDarkModePref = localStorage.getItem('darkModePreference');

        if (savedDarkModePref) {
            initialIsDarkMode = savedDarkModePref === 'dark';
        } else {
            initialIsDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        setAppTheme(initialCustomTheme, initialIsDarkMode);

        if (appThemeSelect) {
            appThemeSelect.addEventListener('change', function() {
                const currentIsDark = document.documentElement.getAttribute('data-theme') === 'dark';
                setAppTheme(this.value, currentIsDark);
            });
        }

        if (appThemeToggle) {
            appThemeToggle.addEventListener('change', function() {
                const currentCustomTheme = document.documentElement.getAttribute('data-custom-theme') || 'default';
                setAppTheme(currentCustomTheme, this.checked);
            });
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('darkModePreference')) { // Only if user hasn't made a specific choice
                const currentCustomTheme = document.documentElement.getAttribute('data-custom-theme') || 'default';
                setAppTheme(currentCustomTheme, e.matches);
            }
        });
        // --- End New Theme Management ---


        if (formulaDisplay) {
          const observer = new IntersectionObserver(
            (entries) =>
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  entry.target.classList.add("is-visible");
                  observer.unobserve(entry.target);
                }
              }),
            { threshold: 0.1 }
          );
          observer.observe(formulaDisplay);
        }
        tTM();
        if (!talentModeToggle.checked) toggleS2();

        const konamiCode = [
          "ArrowUp", "ArrowUp", "ArrowDown", "ArrowDown",
          "ArrowLeft", "ArrowRight", "ArrowLeft", "ArrowRight", "b", "a",
        ];
        let konamiIndex = 0;
        let partyModeTimeout = null;
        document.addEventListener("keydown", function (e) {
          if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT") return;
          const currentKey = e.key.toLowerCase();
          const expectedKey = konamiCode[konamiIndex].toLowerCase();

          if (document.documentElement.classList.contains("party-mode")) {
             // Type Konami code again to turn off party mode immediately
            if (currentKey === expectedKey) {
              konamiIndex++;
              if (konamiIndex === konamiCode.length) {
                clearTimeout(partyModeTimeout);
                document.documentElement.classList.remove("party-mode");
                konamiIndex = 0;
              }
            } else {
              konamiIndex = 0; // Reset if wrong key
            }
            return;
          }

          if (currentKey === expectedKey) {
            konamiIndex++;
            if (konamiIndex === konamiCode.length) {
              document.documentElement.classList.add("party-mode");
              konamiIndex = 0;
              triggerConfetti(); // Add extra confetti for party mode start
              partyModeTimeout = setTimeout(() => {
                document.documentElement.classList.remove("party-mode");
              }, 10000); // Party for 10 seconds!
            }
          } else {
            konamiIndex = 0;
          }
        });

        const resetButton = document.createElement("button");
        resetButton.textContent = "Reset All Inputs & Weights";
        resetButton.className = "primary-action"; // Use existing button class
        resetButton.style.cssText =
          "display: block; margin: 2rem auto; background: var(--accent-warning); max-width: 300px;";
        resetButton.onclick = resetCalculator;
        const footerElement = document.querySelector(".f");
         if (footerElement) {
            footerElement.parentNode.insertBefore(resetButton, footerElement);
        } else {
            document.body.appendChild(resetButton);
        }
      });
      
      function resetCalculator() {
        customWeights = {};
        localStorage.removeItem("customWeights");
        document.getElementById("t-a").value = "";
        document.getElementById("t-f-a").textContent = "0.00";
        document.getElementById("t-f-a").className = "";
        document.getElementById("missing-list").innerHTML = "";
        missing.length = 0;
        if (missingModuleSelect) missingModuleSelect.value = "";

        function resetModItem(moduleItem, moduleDef, isS2M) {
          moduleItem
            .querySelectorAll('input[type="number"].grade-input')
            .forEach((input) => (input.value = ""));
          const avgId = `${
            isS2M ? "a-s2-" : "a-"
          }${moduleDef.code.toLowerCase()}`;
          const avgSpan = document.getElementById(avgId);
          if (avgSpan) {
            avgSpan.textContent = "0.00";
            avgSpan.className = "";
          }
          const mTId = `${
            isS2M ? "s2-" : ""
          }t-m-${moduleDef.code.toLowerCase()}`;
          const mT = document.getElementById(mTId);
          if (mT && mT.checked) {
            mT.checked = false;
            const gC = moduleItem.querySelector(".c-g");
            const mC = moduleItem.querySelector(".m-g");
            if (gC) gC.style.display = "flex";
            if (mC) mC.style.display = "none";
             // Also ensure toggle weights button is visible again
            const toggleWeightsBtn = moduleItem.querySelector(".toggle-weights-btn");
            if(toggleWeightsBtn) toggleWeightsBtn.style.display = "inline-block";
          }
          if (moduleDef.code === "ARCHI" && !isS2M) {
            aB = false;
            const aBtn = document.getElementById("a-b");
            if (aBtn) aBtn.textContent = "Add 1pt Bonus";
          }
          const wP = moduleItem.querySelector(".weights-customization");
          if (wP) {
            wP.classList.remove("visible");
            wP.style.display = "none";
            moduleDef.components.forEach((comp) => {
              const wI = wP.querySelector(
                `.component-weight-input[data-component-id="${comp.id}"]`
              );
              if (wI) wI.value = (comp.defaultWeight * 100).toFixed(1);
            });
            const warnP = wP.querySelector(".weights-sum-warning");
            if (warnP) warnP.style.display = "none";
            moduleItem
              .querySelectorAll(".component-weight-input")
              .forEach((i) => i.classList.remove("invalid-weight-sum"));
          }
        }

        const allSemesters = [
            { modules: mC, containerSelector: '#s1-modules', isS2: false },
            { modules: mC2, containerSelector: '#s2-modules', isS2: true }
        ];
        allSemesters.forEach(semester => {
            semester.modules.forEach(moduleDef => {
                const moduleItem = document.querySelector(
                    `${semester.containerSelector} .module-item[data-code="${moduleDef.code}"]`
                );
                if (moduleItem) {
                    resetModItem(moduleItem, moduleDef, semester.isS2);
                }
            });
        });

        document.getElementById("f-a").textContent = "0.00";
        document.getElementById("f-a").className = "";
        document.getElementById("s2-f-a").textContent = "0.00";
        document.getElementById("s2-f-a").className = "";

        if (talentModeToggle) talentModeToggle.checked = false;
        if (s2ModeToggle) {
          s2ModeToggle.checked = false;
          s2ModeToggle.disabled = false;
        }
        isS2 = false;
        
        const appThemeSelect = document.getElementById('theme-select-dropdown');
        const appThemeToggle = document.getElementById('theme-toggle');
        
        localStorage.removeItem('selectedCustomTheme');
        localStorage.removeItem('darkModePreference');

        let isDarkByDefault = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if(appThemeToggle) appThemeToggle.checked = isDarkByDefault;
        if(appThemeSelect) appThemeSelect.value = 'default';
        
        setAppTheme('default', isDarkByDefault);
        
        tTM();
        if (!talentModeToggle.checked) {
            toggleS2();
        } else {
             isS2 ? cA_S2() : cA();
        }
         cA();
      }


      // --- Confetti ---
      function triggerConfetti() {
        const canvas = document.getElementById("confetti-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const confettiPieces = [];
        const pieceCount = document.documentElement.classList.contains('party-mode') ? 300 : 150; // More for party mode
        
        let colors = ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722"];
        
        const rootStyle = getComputedStyle(document.documentElement);
        const themedAccents = [
            rootStyle.getPropertyValue('--accent-primary').trim(),
            rootStyle.getPropertyValue('--accent-secondary').trim(),
            rootStyle.getPropertyValue('--a').trim(),
            rootStyle.getPropertyValue('--accent-success').trim(),
            rootStyle.getPropertyValue('--accent-warning').trim(),
            rootStyle.getPropertyValue('--text-accent').trim() // Another themed color
        ].filter(c => c && c !== "" && !c.startsWith("rgba")); // Filter out empty or rgba for solid colors

        if (themedAccents.length > 3) { // If we have a good number of themed solid colors
            colors = [...new Set([...themedAccents, ...colors.slice(0, 5)])]; // Mix and unique
        }

        for (let i = 0; i < pieceCount; i++) {
          confettiPieces.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height, 
            size: Math.random() * 8 + 5, 
            speedX: Math.random() * 6 - 3, 
            speedY: Math.random() * 5 + 2, 
            color: colors[Math.floor(Math.random() * colors.length)],
            rotation: Math.random() * 360,
            rotationSpeed: Math.random() * 10 - 5,
            opacity: 1,
            angle: Math.random() * Math.PI * 2, 
            waveFrequency: Math.random() * 0.02 + 0.01,
            waveAmplitude: Math.random() * 20 + 10
          });
        }

        let animationFrameId;
        function updateConfetti() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          let activePieces = 0;
          confettiPieces.forEach((p) => {
            p.y += p.speedY;
            p.x += p.speedX + Math.sin(p.angle) * (p.waveAmplitude/10); 
            p.angle += p.waveFrequency;
            p.rotation += p.rotationSpeed;
            p.speedY *= 0.995; 
            if (p.y < canvas.height * 0.9) p.opacity -= 0.003; 
             else p.opacity -= 0.01; 
            p.opacity = Math.max(0, p.opacity);


            if (p.y < canvas.height && p.x > -p.size && p.x < canvas.width + p.size && p.opacity > 0) {
              activePieces++;
              ctx.save();
              ctx.globalAlpha = p.opacity;
              ctx.fillStyle = p.color;
              ctx.translate(p.x + p.size / 2, p.y + p.size / 2);
              ctx.rotate((p.rotation * Math.PI) / 180);
              ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * (Math.random() > 0.5 ? 1 : 0.5)); 
              ctx.restore();
            }
          });
          if (activePieces > 0) {
            animationFrameId = requestAnimationFrame(updateConfetti);
          } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            if (canvas.width > 0 || canvas.height > 0) { // Avoid error if already 0
                // Optional: collapse canvas to free memory
                // canvas.width = 0; canvas.height = 0; 
            }
          }
        }
        if (typeof animationFrameId !== 'undefined') cancelAnimationFrame(animationFrameId); 
        updateConfetti();
      }
    </script>
  </body>
</html>